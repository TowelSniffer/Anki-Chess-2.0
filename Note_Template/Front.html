<script>
    // User Variables
    var userConfig = {
        muteAudio: false, // set true to suck the joy out of life.
        handicap: 1, // number of wrong attempts before puzzle advances automatically.
        fontSize: 18,
        strictScoring: false, // puzzle is marked wrong with any mistake.
        acceptVariations: true, // allows for multiple lines for both sides.
        flip: false, // sets whether Puzzle begins from First or second move of PGN
        disableArrows: false, // Disables arrows on front side.
        frontText: true, // show userText on front side.
        mirror: false, // card will randomly show up in a mirrored and/or inverted orientation if neither player holds castle rights.
        showDests: true, // Indicate legal moves for clicked piece.
        timer: 0, // Automatically mark the answer wrong after this number of ms. Set to 0 to disable.
        autoAdvance: false, // Automatically show answer when player solves puzzle or uses up all attempts incorrectly
    }
</script>
<script src="_persistence.js"></script>
<iframe id="Board" style="visibility: hidden"></iframe>
<script>
    (function initIframe() {
        {{#textField}}
        // optional user text
        let userText = `{{textField}}`
        userText = encodeURIComponent(userText)
        {{/textField}}

        // note must use const here as variables are remembered when loading new cards/backside
        const background = window.getComputedStyle( document.body ,null).getPropertyValue('background-color');
        let PGN = `{{text:PGN}}`.replace(/\[Puzzle_Length.*?\]/, '').replace(/\[Tactic_line.*?\]/, '').replace("[%", "[ %");
        ; //compatability with chess.com puzzles
        PGN = encodeURIComponent(PGN);
        const iframe = document.getElementById("Board");
        iframe.onload = function() { iframe.style.visibility = "visible"; }
        iframe.src = `_chess3.0.html?{{#textField}}userText=` + userText + `&{{/textField}}PGN=`+PGN+`&flip=`+userConfig.flip+`&handicap=`+userConfig.handicap+`&background=`+background+`&acceptVariations=`+userConfig.acceptVariations+`&disableArrows=`+userConfig.disableArrows+`&frontText=`+userConfig.frontText+`&fontSize=`+userConfig.fontSize+`&muteAudio=`+userConfig.muteAudio+`&mirror=`+userConfig.mirror+`&showDests=`+userConfig.showDests+`&autoAdvance=`+userConfig.autoAdvance+`&strictScoring=`+userConfig.strictScoring+`&boardMode=Puzzle`;
        let errorTrack;
        let mirrorState;
        let pgnPath = null;
        let errorCount = null;
        let puzzleComplete = null;
        if (Persistence.isAvailable()) {
            Persistence.clear();
            // checking window.hasChessListener prevents the event listener from being added multiple times
            if (typeof window.addEventListener != 'undefined' && !window.hasChessListener) {
                window.hasChessListener = true;
                window.addEventListener('message', function(e) {
                    errorTrack = e.data.errorTrack;
                    mirrorState = e.data.mirrorState;
                    errorCount = e.data.errorCount;
                    puzzleComplete = e.data.puzzleComplete;
                    pgnPath = e.data.pgnPath;
                    Persistence.setItem("errorTrack", errorTrack);
                    Persistence.setItem("mirrorState", mirrorState);
                    Persistence.setItem("pgnPath", pgnPath);
                    if (userConfig.autoAdvance === true && puzzleComplete === true) {
                        if (typeof showAnswer === 'function') {
                            showAnswer();
                        } else if (typeof pycmd === 'function') {
                            pycmd("ans");
                        }
                    }
                }, false);
            }
            function handleExpiredTimer() {
                if (puzzleComplete === false) {
                    errorTrack = true;
                    Persistence.setItem("errorTrack", errorTrack);
                }
                if (typeof showAnswer === 'function') {
                    showAnswer();
                } else if (typeof pycmd === 'function') {
                    pycmd("ans");
                }
            }

            if (userConfig.timer > 0) {
                const timeoutId = setTimeout(handleExpiredTimer, userConfig.timer);
                Persistence.setItem("timeoutId", timeoutId);
            }
        }
    })();
</script>

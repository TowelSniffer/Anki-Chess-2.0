<script>
    // User Variables
    var userConfig = {
        fontSize: 18, // The font size for the puzzle text.
        frontText: false, // Show userText on front side.
        muteAudio: false,
        puzzleSettings: {
            _title: "Puzzle Settings",
            _collapsed: false,
            flip: false, // Sets whether Puzzle begins from First or second move of PGN.
            handicap: 1, // Number of wrong attempts before puzzle advances automatically.
            strictScoring: false, // Puzzle is marked wrong with any mistake.
            acceptVariations: true, // Allows for multiple lines for both sides.
        },
        boardSettings: {
            _title: "Board Settings",
            _collapsed: true,
            disableArrows: false, // Disables arrows on front side.
            showDests: true, // Indicate legal moves for clicked piece.
        },
        mirrorSettings: {
            _title: "Mirror Settings",
            _collapsed: true,
            mirror: false, // Card will randomly show up in a mirrored and/or inverted orientation if neither player holds castle rights.
            randomOrientation: false, // Sets a grey border and random board rotation.
        },
        timerSettings: {
            _title: "Timer Settings",
            _collapsed: true,
            timer: 0, // Max solve time in seconds. Set to 0 to diable.
            increment: 0, // Increase Max time with each move.
            timerScore: true, // Mark puzzle incorrect when out of time.
        },
        autoAdvanceSettings: {
            _title: "autoAdvance Settings",
            _collapsed: true, // This section will be closed by default
            autoAdvance: false, // Automatically show answer when player reaches end of line. Anki mobile not supported.
            handicapAdvance: false, // Also show answer when handicap is reached.
            timerAdvance: true, // Also show answer when timer runs out.
        },
    }
</script>
<script src="_persistence.js"></script>
<iframe id="Board" style="visibility: hidden"></iframe>
<script>
    (function initIframe() {
        {{#textField}}
        // optional user text
        let userText = `{{textField}}`
        userText = encodeURIComponent(userText)
        {{/textField}}

        // note must use const here as variables are remembered when loading new cards/backside
        const background = window.getComputedStyle( document.body ,null).getPropertyValue('background-color');
        let PGN = `{{text:PGN}}`.replace(/\[Puzzle_Length.*?\]/, '').replace(/\[Tactic_line.*?\]/, '').replace("[%", "[ %");
        ; //compatability with chess.com puzzles
        PGN = encodeURIComponent(PGN);
        const iframe = document.getElementById("Board");
        iframe.onload = function() { iframe.style.visibility = "visible"; }
        iframe.src = `_chess3.0.html?{{#textField}}userText=` + userText + `&{{/textField}}PGN=`+PGN+`&flip=`+userConfig.puzzleSettings.flip+`&timer=`+userConfig.timerSettings.timer+`&increment=`+userConfig.timerSettings.increment+`&timerAdvance=`+userConfig.autoAdvanceSettings.timerAdvance+`&timerScore=`+userConfig.timerSettings.timerScore+`&handicap=`+userConfig.puzzleSettings.handicap+`&background=`+background+`&acceptVariations=`+userConfig.puzzleSettings.acceptVariations+`&disableArrows=`+userConfig.boardSettings.disableArrows+`&frontText=`+userConfig.frontText+`&fontSize=`+userConfig.fontSize+`&muteAudio=`+userConfig.muteAudio+`&mirror=`+userConfig.mirrorSettings.mirror+`&randomOrientation=`+userConfig.mirrorSettings.randomOrientation+`&showDests=`+userConfig.boardSettings.showDests+`&autoAdvance=`+userConfig.autoAdvanceSettings.autoAdvance+`&handicapAdvance=`+userConfig.autoAdvanceSettings.handicapAdvance+`&strictScoring=`+userConfig.puzzleSettings.strictScoring+`&boardMode=Puzzle`;
        let errorTrack;
        let mirrorState;
        let pgnPath = null;
        let errorCount = null;
        let puzzleComplete = null;
        if (Persistence.isAvailable()) {
            Persistence.clear();
            // checking window.hasChessListener prevents the event listener from being added multiple times
            if (typeof window.addEventListener != 'undefined' && !window.hasChessListener) {
                window.hasChessListener = true;
                window.addEventListener('message', function(e) {
                    errorTrack = e.data.errorTrack;
                    mirrorState = e.data.mirrorState;
                    errorCount = e.data.errorCount;
                    puzzleComplete = e.data.puzzleComplete;
                    pgnPath = e.data.pgnPath;
                    Persistence.setItem("errorTrack", errorTrack);
                    Persistence.setItem("mirrorState", mirrorState);
                    Persistence.setItem("pgnPath", pgnPath);
                    if (userConfig.autoAdvanceSettings.autoAdvance && puzzleComplete === true) {
                        if (typeof showAnswer === 'function') {
                            showAnswer();
                        } else if (typeof pycmd === 'function') {
                            pycmd("ans");
                        }
                    }
                }, false);
            }
        }
    })();
</script>

var Pe=["a","b","c","d","e","f","g","h"],Je=["1","2","3","4","5","6","7","8"],$=["white","black"],U=["pawn","knight","bishop","rook","queen","king"],qn=["a","h"],oe=e=>"role"in e;var k=e=>e!==void 0,M=e=>e==="white"?"black":"white",J=e=>e>>3,B=e=>e&7,et=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,se=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Me(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ue(e){if(e.length===2)return et(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}var j=e=>Pe[B(e)]+Je[J(e)];var Lt=e=>oe(e)?`${se(e.role).toUpperCase()}@${j(e.to)}`:j(e.from)+j(e.to)+(e.promotion?se(e.promotion):""),Ke=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,tt=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61;var Dn=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),It=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),Bn=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,It(e)),l=class e{constructor(t,n){this.lo=t|0,this.hi=n|0}static fromSquare(t){return t>=32?new e(0,1<<t-32):new e(1<<t,0)}static fromRank(t){return new e(255,0).shl64(8*t)}static fromFile(t){return new e(16843009<<t,16843009<<t)}static empty(){return new e(0,0)}static full(){return new e(4294967295,4294967295)}static corners(){return new e(129,2164260864)}static center(){return new e(402653184,24)}static backranks(){return new e(255,4278190080)}static backrank(t){return t==="white"?new e(255,0):new e(0,4278190080)}static lightSquares(){return new e(1437226410,1437226410)}static darkSquares(){return new e(2857740885,2857740885)}complement(){return new e(~this.lo,~this.hi)}xor(t){return new e(this.lo^t.lo,this.hi^t.hi)}union(t){return new e(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new e(this.lo&t.lo,this.hi&t.hi)}diff(t){return new e(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?e.empty():t>=32?new e(this.hi>>>t-32,0):t>0?new e(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?e.empty():t>=32?new e(0,this.lo<<t-32):t>0?new e(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new e(It(this.hi),It(this.lo))}rbit64(){return new e(Bn(this.hi),Bn(this.lo))}minus64(t){let n=this.lo-t.lo,r=(n&t.lo&1)+(t.lo>>>1)+(n>>>1)>>>31;return new e(n,this.hi-(t.hi+r))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Dn(this.lo)+Dn(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,n){return n?this.with(t):this.without(t)}with(t){return t>=32?new e(this.lo,this.hi|1<<t-32):new e(this.lo|1<<t,this.hi)}without(t){return t>=32?new e(this.lo,this.hi&~(1<<t-32)):new e(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new e(this.lo,this.hi^1<<t-32):new e(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new e(this.lo&this.lo-1,this.hi):new e(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,n=this.hi;for(;t!==0;){let r=31-Math.clz32(t&-t);t^=1<<r,yield r}for(;n!==0;){let r=31-Math.clz32(n&-n);n^=1<<r,yield 32+r}}*reversed(){let t=this.lo,n=this.hi;for(;n!==0;){let r=31-Math.clz32(n);n^=1<<r,yield 32+r}for(;t!==0;){let r=31-Math.clz32(t);t^=1<<r,yield r}}};var nt=(e,t)=>{let n=l.empty();for(let r of t){let i=e+r;0<=i&&i<64&&Math.abs(B(e)-B(i))<=2&&(n=n.with(i))}return n},ke=e=>{let t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},Pi=ke(e=>nt(e,[-9,-8,-7,-1,1,7,8,9])),Mi=ke(e=>nt(e,[-17,-15,-10,-6,6,10,15,17])),Ei={white:ke(e=>nt(e,[7,9])),black:ke(e=>nt(e,[-7,-9]))},ae=e=>Pi[e],Te=e=>Mi[e],be=(e,t)=>Ei[e][t],Kt=ke(e=>l.fromFile(B(e)).without(e)),zt=ke(e=>l.fromRank(J(e)).without(e)),Ft=ke(e=>{let t=new l(134480385,2151686160),n=8*(J(e)-B(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),Ht=ke(e=>{let t=new l(270549120,16909320),n=8*(J(e)+B(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),$t=(e,t,n)=>{let r=n.intersect(t),i=r.bswap64();return r=r.minus64(e),i=i.minus64(e.bswap64()),r.xor(i.bswap64()).intersect(t)},Ai=(e,t)=>$t(l.fromSquare(e),Kt[e],t),_i=(e,t)=>{let n=zt[e],r=t.intersect(n),i=r.rbit64();return r=r.minus64(l.fromSquare(e)),i=i.minus64(l.fromSquare(63-e)),r.xor(i.rbit64()).intersect(n)},we=(e,t)=>{let n=l.fromSquare(e);return $t(n,Ft[e],t).xor($t(n,Ht[e],t))},ve=(e,t)=>Ai(e,t).xor(_i(e,t)),ze=(e,t)=>we(e,t).xor(ve(e,t)),rt=(e,t,n)=>{switch(e.role){case"pawn":return be(e.color,t);case"knight":return Te(t);case"bishop":return we(t,n);case"rook":return ve(t,n);case"queen":return ze(t,n);case"king":return ae(t)}},Vt=(e,t)=>{let n=l.fromSquare(t);return zt[e].intersects(n)?zt[e].with(e):Ht[e].intersects(n)?Ht[e].with(e):Ft[e].intersects(n)?Ft[e].with(e):Kt[e].intersects(n)?Kt[e].with(e):l.empty()},ye=(e,t)=>Vt(e,t).intersect(l.full().shl64(e).xor(l.full().shl64(t))).withoutFirst();var he=class e{constructor(){}static default(){let t=new e;return t.reset(),t}reset(){this.occupied=new l(65535,4294901760),this.promoted=l.empty(),this.white=new l(65535,0),this.black=new l(0,4294901760),this.pawn=new l(65280,16711680),this.knight=new l(66,1107296256),this.bishop=new l(36,603979776),this.rook=new l(129,2164260864),this.queen=new l(8,134217728),this.king=new l(16,268435456)}static empty(){let t=new e;return t.clear(),t}clear(){this.occupied=l.empty(),this.promoted=l.empty();for(let t of $)this[t]=l.empty();for(let t of U)this[t]=l.empty()}clone(){let t=new e;t.occupied=this.occupied,t.promoted=this.promoted;for(let n of $)t[n]=this[n];for(let n of U)t[n]=this[n];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(let n of U)if(this[n].has(t))return n}get(t){let n=this.getColor(t);if(!n)return;let r=this.getRole(t),i=this.promoted.has(t);return{color:n,role:r,promoted:i}}take(t){let n=this.get(t);return n&&(this.occupied=this.occupied.without(t),this[n.color]=this[n.color].without(t),this[n.role]=this[n.role].without(t),n.promoted&&(this.promoted=this.promoted.without(t))),n}set(t,n){let r=this.take(t);return this.occupied=this.occupied.with(t),this[n.color]=this[n.color].with(t),this[n.role]=this[n.role].with(t),n.promoted&&(this.promoted=this.promoted.with(t)),r}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(let t of this.occupied)yield[t,this.get(t)]}pieces(t,n){return this[t].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}};var de=class e{constructor(){}static empty(){let t=new e;for(let n of U)t[n]=0;return t}static fromBoard(t,n){let r=new e;for(let i of U)r[i]=t.pieces(n,i).size();return r}clone(){let t=new e;for(let n of U)t[n]=this[n];return t}equals(t){return U.every(n=>this[n]===t[n])}add(t){let n=new e;for(let r of U)n[r]=this[r]+t[r];return n}subtract(t){let n=new e;for(let r of U)n[r]=this[r]-t[r];return n}nonEmpty(){return U.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},Ee=class e{constructor(t,n){this.white=t,this.black=n}static empty(){return new e(de.empty(),de.empty())}static fromBoard(t){return new e(de.fromBoard(t,"white"),de.fromBoard(t,"black"))}clone(){return new e(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new e(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new e(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},xe=class e{constructor(t,n){this.white=t,this.black=n}static default(){return new e(3,3)}clone(){return new e(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}};var it=class{unwrap(t,n){let r=this._chain(i=>m.ok(t?t(i):i),i=>n?m.ok(n(i)):m.err(i));if(r.isErr)throw r.error;return r.value}map(t,n){return this._chain(r=>m.ok(t(r)),r=>m.err(n?n(r):r))}chain(t,n){return this._chain(t,n||(r=>m.err(r)))}},Gt=class extends it{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,n){return t(this.value)}},Wt=class extends it{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,n){return n(this.error)}},m;(function(e){e.ok=function(t){return new Gt(t)},e.err=function(t){return new Wt(t||new Error)},e.all=function(t){if(Array.isArray(t)){let i=[];for(let o=0;o<t.length;o++){let s=t[o];if(s.isErr)return s;i.push(s.value)}return e.ok(i)}let n={},r=Object.keys(t);for(let i=0;i<r.length;i++){let o=t[r[i]];if(o.isErr)return o;n[r[i]]=o.value}return e.ok(n)}})(m||(m={}));var q;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(q||(q={}));var D=class extends Error{},Ni=(e,t,n,r)=>n[t].intersect(ve(e,r).intersect(n.rooksAndQueens()).union(we(e,r).intersect(n.bishopsAndQueens())).union(Te(e).intersect(n.knight)).union(ae(e).intersect(n.king)).union(be(M(t),e).intersect(n.pawn))),ce=class e{constructor(){}static default(){let t=new e;return t.castlingRights=l.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new l(14,0),h:new l(96,0)},black:{a:new l(0,234881024),h:new l(0,1610612736)}},t}static empty(){let t=new e;return t.castlingRights=l.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:l.empty(),h:l.empty()},black:{a:l.empty(),h:l.empty()}},t}clone(){let t=new e;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,n,r,i){let o=Ke(t,n),s=tt(t,n);this.castlingRights=this.castlingRights.with(i),this.rook[t][n]=i,this.path[t][n]=ye(i,s).with(s).union(ye(r,o).with(o)).without(r).without(i)}static fromSetup(t){let n=e.empty(),r=t.castlingRights.intersect(t.board.rook);for(let i of $){let o=l.backrank(i),s=t.board.kingOf(i);if(!k(s)||!o.has(s))continue;let a=r.intersect(t.board[i]).intersect(o),u=a.first();k(u)&&u<s&&n.add(i,"a",s,u);let c=a.last();k(c)&&s<c&&n.add(i,"h",s,c)}return n}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(let n of $)for(let r of qn)this.rook[n][r]===t&&(this.rook[n][r]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(l.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}},ee=class{constructor(t){this.rules=t}reset(){this.board=he.default(),this.pockets=void 0,this.turn="white",this.castles=ce.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=l.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=ce.fromSetup(t),this.epSquare=Ri(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,n,r){return Ni(t,n,this.board,r)}playCaptureAt(t,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[M(n.color)][n.promoted?"pawn":n.role]++}ctx(){let t=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!k(n))return{king:n,blockers:l.empty(),checkers:l.empty(),variantEnd:t,mustCapture:!1};let r=ve(n,l.empty()).intersect(this.board.rooksAndQueens()).union(we(n,l.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[M(this.turn)]),i=l.empty();for(let s of r){let a=ye(n,s).intersect(this.board.occupied);a.moreThanOne()||(i=i.union(a))}let o=this.kingAttackers(n,M(this.turn),this.board.occupied);return{king:n,blockers:i,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,n;let r=new this.constructor;return r.board=this.board.clone(),r.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),r.turn=this.turn,r.castles=this.castles.clone(),r.epSquare=this.epSquare,r.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),r.halfmoves=this.halfmoves,r.fullmoves=this.fullmoves,r}validate(){if(this.board.occupied.isEmpty())return m.err(new D(q.Empty));if(this.board.king.size()!==2)return m.err(new D(q.Kings));if(!k(this.board.kingOf(this.turn)))return m.err(new D(q.Kings));let t=this.board.kingOf(M(this.turn));return k(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?m.err(new D(q.OppositeCheck)):l.backranks().intersects(this.board.pawn)?m.err(new D(q.PawnsOnBackrank)):m.ok(void 0):m.err(new D(q.Kings))}dropDests(t){return l.empty()}dests(t,n){if(n=n||this.ctx(),n.variantEnd)return l.empty();let r=this.board.get(t);if(!r||r.color!==this.turn)return l.empty();let i,o;if(r.role==="pawn"){i=be(this.turn,t).intersect(this.board[M(this.turn)]);let s=this.turn==="white"?8:-8,a=t+s;if(0<=a&&a<64&&!this.board.occupied.has(a)){i=i.with(a);let u=this.turn==="white"?t<16:t>=48,c=a+s;u&&!this.board.occupied.has(c)&&(i=i.with(c))}k(this.epSquare)&&Ti(this,t,n)&&(o=l.fromSquare(this.epSquare))}else r.role==="bishop"?i=we(t,this.board.occupied):r.role==="knight"?i=Te(t):r.role==="rook"?i=ve(t,this.board.occupied):r.role==="queen"?i=ze(t,this.board.occupied):i=ae(t);if(i=i.diff(this.board[this.turn]),k(n.king)){if(r.role==="king"){let s=this.board.occupied.without(t);for(let a of i)this.kingAttackers(a,M(this.turn),s).nonEmpty()&&(i=i.without(a));return i.union(ot(this,"a",n)).union(ot(this,"h",n))}if(n.checkers.nonEmpty()){let s=n.checkers.singleSquare();if(!k(s))return l.empty();i=i.intersect(ye(s,n.king).with(s))}n.blockers.has(t)&&(i=i.intersect(Vt(t,n.king)))}return o&&(i=i.union(o)),i}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[M(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(l.darkSquares())||!this.board.bishop.intersects(l.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,n;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Oi(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return $.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(let n of this.board[this.turn])if(this.dests(n,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,n){if(oe(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&l.backranks().has(t.to)?!1:this.dropDests(n).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&l.backranks().has(t.to)))return!1;let r=this.dests(t.from,n);return r.has(t.to)||r.has(Ln(this,t).to)}}isCheck(){let t=this.board.kingOf(this.turn);return k(t)&&this.kingAttackers(t,M(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){let n=this.variantOutcome(t);return n||(t=t||this.ctx(),this.isCheckmate(t)?{winner:M(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();let n=new Map;if(t.variantEnd)return n;for(let r of this.board[this.turn])n.set(r,this.dests(r,t));return n}play(t){let n=this.turn,r=this.epSquare,i=Ut(this,t);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=M(n),oe(t))this.board.set(t.to,{role:t.role,color:n}),this.pockets&&this.pockets[n][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{let o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===r&&(s=this.board.take(t.to+(n==="white"?-8:8)));let a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(i){let a=this.castles.rook[n][i];if(k(a)){let u=this.board.take(a);this.board.set(Ke(n,i),o),u&&this.board.set(tt(n,i),u)}}this.castles.discardColor(n)}if(!i){let a=this.board.set(t.to,o)||s;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}},Fe=class extends ee{constructor(){super("chess")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}},Ri=(e,t)=>{if(!k(t))return;let n=e.turn==="white"?5:2,r=e.turn==="white"?8:-8;if(J(t)!==n||e.board.occupied.has(t+r))return;let i=t-r;if(!(!e.board.pawn.has(i)||!e.board[M(e.turn)].has(i)))return t},Oi=e=>{if(!k(e.epSquare))return;let t=e.ctx(),r=e.board.pieces(e.turn,"pawn").intersect(be(M(e.turn),e.epSquare));for(let i of r)if(e.dests(i,t).has(e.epSquare))return e.epSquare},Ti=(e,t,n)=>{if(!k(e.epSquare)||!be(e.turn,t).has(e.epSquare))return!1;if(!k(n.king))return!0;let r=e.turn==="white"?8:-8,i=e.epSquare-r;return e.kingAttackers(n.king,M(e.turn),e.board.occupied.toggle(t).toggle(i).with(e.epSquare)).without(i).isEmpty()},ot=(e,t,n)=>{if(!k(n.king)||n.checkers.nonEmpty())return l.empty();let r=e.castles.rook[e.turn][t];if(!k(r))return l.empty();if(e.castles.path[e.turn][t].intersects(e.board.occupied))return l.empty();let i=Ke(e.turn,t),o=ye(n.king,i),s=e.board.occupied.without(n.king);for(let c of o)if(e.kingAttackers(c,M(e.turn),s).nonEmpty())return l.empty();let a=tt(e.turn,t),u=e.board.occupied.toggle(n.king).toggle(r).toggle(a);return e.kingAttackers(i,M(e.turn),u).nonEmpty()?l.empty():l.fromSquare(r)},st=(e,t,n)=>{if(n.variantEnd)return l.empty();let r=e.board.get(t);if(!r||r.color!==e.turn)return l.empty();let i=rt(r,t,e.board.occupied);if(r.role==="pawn"){let o=e.board[M(e.turn)];k(e.epSquare)&&(o=o.with(e.epSquare)),i=i.intersect(o);let s=e.turn==="white"?8:-8,a=t+s;if(0<=a&&a<64&&!e.board.occupied.has(a)){i=i.with(a);let u=e.turn==="white"?t<16:t>=48,c=a+s;u&&!e.board.occupied.has(c)&&(i=i.with(c))}return i}else i=i.diff(e.board[e.turn]);return t===n.king?i.union(ot(e,"a",n)).union(ot(e,"h",n)):i};var Ut=(e,t)=>{if(oe(t))return;let n=t.to-t.from;if(!(Math.abs(n)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return n>0?"h":"a"},Ln=(e,t)=>{let n=Ut(e,t);if(!n)return t;let r=e.castles.rook[e.turn][n];return{from:t.from,to:k(r)?r:t.to}};var In=e=>oe(e)?String.fromCharCode(35+e.to,99+8*5+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?99+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+B(e.to):35+e.to);var Di="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Bi=Di+" w KQkq -",wa=Bi+" 0 1",Li="8/8/8/8/8/8/8/8",Ii=Li+" w - -",va=Ii+" 0 1",z;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(z||(z={}));var F=class extends Error{},Ki=(e,t,n)=>{let r=e.indexOf(t);for(;n-- >0&&r!==-1;)r=e.indexOf(t,r+t.length);return r},qe=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,Hn=e=>{let t=Me(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},jt=e=>{let t=he.empty(),n=7,r=0;for(let i=0;i<e.length;i++){let o=e[i];if(o==="/"&&r===8)r=0,n--;else{let s=parseInt(o,10);if(s>0)r+=s;else{if(r>=8||n<0)return m.err(new F(z.Board));let a=r+n*8,u=Hn(o);if(!u)return m.err(new F(z.Board));e[i+1]==="~"&&(u.promoted=!0,i++),t.set(a,u),r++}}}return n!==0||r!==8?m.err(new F(z.Board)):m.ok(t)},Kn=e=>{if(e.length>64)return m.err(new F(z.Pockets));let t=Ee.empty();for(let n of e){let r=Hn(n);if(!r)return m.err(new F(z.Pockets));t[r.color][r.role]++}return m.ok(t)},zi=(e,t)=>{let n=l.empty();if(t==="-")return m.ok(n);for(let r of t){let i=r.toLowerCase(),o=r===i?"black":"white",s=o==="white"?0:7;if("a"<=i&&i<="h")n=n.with(et(i.charCodeAt(0)-97,s));else if(i==="k"||i==="q"){let a=e[o].intersect(l.backrank(o)).intersect(e.rook.union(e.king)),u=i==="k"?a.last():a.first();n=n.with(k(u)&&e.rook.has(u)?u:et(i==="k"?7:0,s))}else return m.err(new F(z.Castling))}return $.some(r=>l.backrank(r).intersect(n).size()>2)?m.err(new F(z.Castling)):m.ok(n)},zn=e=>{let t=e.split("+");if(t.length===3&&t[0]===""){let n=qe(t[1]),r=qe(t[2]);return!k(n)||n>3||!k(r)||r>3?m.err(new F(z.RemainingChecks)):m.ok(new xe(3-n,3-r))}else if(t.length===2){let n=qe(t[0]),r=qe(t[1]);return!k(n)||n>3||!k(r)||r>3?m.err(new F(z.RemainingChecks)):m.ok(new xe(n,r))}else return m.err(new F(z.RemainingChecks))},$n=e=>{let t=e.split(/[\s_]+/),n=t.shift(),r,i=m.ok(void 0);if(n.endsWith("]")){let a=n.indexOf("[");if(a===-1)return m.err(new F(z.Fen));r=jt(n.slice(0,a)),i=Kn(n.slice(a+1,-1))}else{let a=Ki(n,"/",7);a===-1?r=jt(n):(r=jt(n.slice(0,a)),i=Kn(n.slice(a+1)))}let o,s=t.shift();if(!k(s)||s==="w")o="white";else if(s==="b")o="black";else return m.err(new F(z.Turn));return r.chain(a=>{let u=t.shift(),c=k(u)?zi(a,u):m.ok(l.empty()),p=t.shift(),f;if(k(p)&&p!=="-"&&(f=ue(p),!k(f)))return m.err(new F(z.EpSquare));let S=t.shift(),b;k(S)&&S.includes("+")&&(b=zn(S),S=t.shift());let h=k(S)?qe(S):0;if(!k(h))return m.err(new F(z.Halfmoves));let d=t.shift(),w=k(d)?qe(d):1;if(!k(w))return m.err(new F(z.Fullmoves));let g=t.shift(),y=m.ok(void 0);if(k(g)){if(k(b))return m.err(new F(z.RemainingChecks));y=zn(g)}else k(b)&&(y=b);return t.length>0?m.err(new F(z.Fen)):i.chain(A=>c.chain(x=>y.map(C=>({board:a,pockets:A,turn:o,castlingRights:x,remainingChecks:C,epSquare:f,halfmoves:h,fullmoves:Math.max(1,w)}))))})};var Fi=e=>{let t=se(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},Hi=e=>{let t="",n=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){let o=i+r*8,s=e.get(o);s?(n>0&&(t+=n,n=0),t+=Fi(s)):n++,i===7&&(n>0&&(t+=n,n=0),r!==0&&(t+="/"))}return t},Fn=e=>U.map(t=>se(t).repeat(e[t])).join(""),$i=e=>Fn(e.white).toUpperCase()+Fn(e.black),Vi=(e,t)=>{let n="";for(let r of $){let i=l.backrank(r),o=e.kingOf(r);k(o)&&!i.has(o)&&(o=void 0);let s=e.pieces(r,"rook").intersect(i);for(let a of t.intersect(i).reversed())if(a===s.first()&&k(o)&&a<o)n+=r==="white"?"Q":"q";else if(a===s.last()&&k(o)&&o<a)n+=r==="white"?"K":"k";else{let u=Pe[B(a)];n+=r==="white"?u.toUpperCase():u}}return n||"-"},Gi=e=>`${e.white}+${e.black}`,at=(e,t)=>[Hi(e.board)+(e.pockets?`[${$i(e.pockets)}]`:""),e.turn[0],Vi(e.board,e.castlingRights),k(e.epSquare)?j(e.epSquare):"-",...e.remainingChecks?[Gi(e.remainingChecks)]:[],...t?.epd?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var Ui=(e,t)=>{let n="";if(oe(t))t.role!=="pawn"&&(n=se(t.role).toUpperCase()),n+="@"+j(t.to);else{let r=e.board.getRole(t.from);if(!r)return"--";if(r==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))n=t.to>t.from?"O-O":"O-O-O";else{let i=e.board.occupied.has(t.to)||r==="pawn"&&B(t.from)!==B(t.to);if(r!=="pawn"){n=se(r).toUpperCase();let o;if(r==="king"?o=ae(t.to).intersect(e.board.king):r==="queen"?o=ze(t.to,e.board.occupied).intersect(e.board.queen):r==="rook"?o=ve(t.to,e.board.occupied).intersect(e.board.rook):r==="bishop"?o=we(t.to,e.board.occupied).intersect(e.board.bishop):o=Te(t.to).intersect(e.board.knight),o=o.intersect(e.board[e.turn]).without(t.from),o.nonEmpty()){let s=e.ctx();for(let a of o)e.dests(a,s).has(t.to)||(o=o.without(a));if(o.nonEmpty()){let a=!1,u=o.intersects(l.fromRank(J(t.from)));o.intersects(l.fromFile(B(t.from)))?a=!0:u=!0,u&&(n+=Pe[B(t.from)]),a&&(n+=Je[J(t.from)])}}}else i&&(n=Pe[B(t.from)]);i&&(n+="x"),n+=j(t.to),t.promotion&&(n+="="+se(t.promotion).toUpperCase())}}return n},Vn=(e,t)=>{var n;let r=Ui(e,t);return e.play(t),!((n=e.outcome())===null||n===void 0)&&n.winner?r+"#":e.isCheck()?r+"+":r};var Gn=(e,t)=>{let n=e.ctx(),r=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!r){let p;if(t==="O-O"||t==="O-O+"||t==="O-O#"?p="h":(t==="O-O-O"||t==="O-O-O+"||t==="O-O-O#")&&(p="a"),p){let b=e.castles.rook[e.turn][p];return!k(n.king)||!k(b)||!e.dests(n.king,n).has(b)?void 0:{from:n.king,to:b}}let f=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!f)return;let S={role:f[1]?Me(f[1]):"pawn",to:ue(f[2])};return e.isLegal(S,n)?S:void 0}let i=r[1]?Me(r[1]):"pawn",o=ue(r[4]),s=r[5]?Me(r[5]):void 0;if(!!s!==(i==="pawn"&&l.backranks().has(o))||s==="king"&&e.rules!=="antichess")return;let a=e.board.pieces(e.turn,i);i==="pawn"&&!r[2]?a=a.intersect(l.fromFile(B(o))):r[2]&&(a=a.intersect(l.fromFile(r[2].charCodeAt(0)-97))),r[3]&&(a=a.intersect(l.fromRank(r[3].charCodeAt(0)-49)));let u=i==="pawn"?l.fromFile(B(o)):l.empty();a=a.intersect(u.union(rt({color:M(e.turn),role:i},o,e.board.occupied)));let c;for(let p of a)if(e.dests(p,n).has(o)){if(k(c))return;c=p}if(k(c))return{from:c,to:o,promotion:s}};var ct=class extends ee{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=Ee.empty()}setupUnchecked(t){super.setupUnchecked(t),this.board.promoted=t.board.promoted.intersect(t.board.occupied).diff(t.board.king).diff(t.board.pawn),this.pockets=t.pockets?t.pockets.clone():Ee.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}validate(){return super.validate().chain(t=>{var n,r;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?m.err(new D(q.Kings)):(((r=this.pockets)===null||r===void 0?void 0:r.size())||0)+this.board.occupied.size()>64?m.err(new D(q.Variant)):m.ok(void 0)})}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(t)}dropDests(t){var n,r;let i=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?l.full():!((r=this.pockets)===null||r===void 0)&&r[this.turn].hasPawns()?l.backranks().complement():l.empty());if(t=t||this.ctx(),k(t.king)&&t.checkers.nonEmpty()){let o=t.checkers.singleSquare();return k(o)?i.intersect(ye(o,t.king)):l.empty()}else return i}},lt=class extends ee{constructor(){super("atomic")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return m.err(new D(q.Empty));if(this.board.king.size()>2)return m.err(new D(q.Kings));let t=this.board.kingOf(M(this.turn));return k(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?m.err(new D(q.OppositeCheck)):l.backranks().intersects(this.board.pawn)?m.err(new D(q.PawnsOnBackrank)):m.ok(void 0):m.err(new D(q.Kings))}kingAttackers(t,n,r){let i=this.board.pieces(n,"king");return i.isEmpty()||ae(t).intersects(i)?l.empty():super.kingAttackers(t,n,r)}playCaptureAt(t,n){super.playCaptureAt(t,n),this.board.take(t);for(let r of ae(t).intersect(this.board.occupied).diff(this.board.pawn)){let i=this.board.take(r);i?.role==="rook"&&this.castles.discardRook(r),i?.role==="king"&&this.castles.discardColor(i.color)}}hasInsufficientMaterial(t){if(this.board.pieces(M(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[M(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(l.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(l.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(l.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(l.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(t,n){n=n||this.ctx();let r=l.empty();for(let i of st(this,t,n)){let o=this.clone();o.play({from:t,to:i});let s=o.board.kingOf(this.turn);k(s)&&(!k(o.board.kingOf(o.turn))||o.kingAttackers(s,o.turn,o.board.occupied).isEmpty())&&(r=r.with(i))}return r}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(let n of $)if(this.board.pieces(n,"king").isEmpty())return{winner:M(n)}}},ut=class extends ee{constructor(){super("antichess")}reset(){super.reset(),this.castles=ce.empty()}setupUnchecked(t){super.setupUnchecked(t),this.castles=ce.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?m.err(new D(q.Empty)):l.backranks().intersects(this.board.pawn)?m.err(new D(q.PawnsOnBackrank)):m.ok(void 0)}kingAttackers(t,n,r){return l.empty()}ctx(){let t=super.ctx();if(k(this.epSquare)&&be(M(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return t.mustCapture=!0,t;let n=this.board[M(this.turn)];for(let r of this.board[this.turn])if(st(this,r,t).intersects(n))return t.mustCapture=!0,t;return t}dests(t,n){n=n||this.ctx();let r=st(this,t,n),i=this.board[M(this.turn)];return r.intersect(n.mustCapture?k(this.epSquare)&&this.board.getRole(t)==="pawn"?i.with(this.epSquare):i:l.full())}hasInsufficientMaterial(t){if(this.board[t].isEmpty())return!1;if(this.board[M(t)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){let n=this.board[t].intersects(l.lightSquares()),r=this.board[t].intersects(l.darkSquares()),i=this.board[M(t)].isDisjoint(l.lightSquares()),o=this.board[M(t)].isDisjoint(l.darkSquares());return n&&i||r&&o}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(l.lightSquares())!==this.board.black.intersects(l.darkSquares())!=(this.turn===t):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if(t=t||this.ctx(),t.variantEnd||this.isStalemate(t))return{winner:this.turn}}},ht=class extends ee{constructor(){super("kingofthehill")}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(l.center())}variantOutcome(t){for(let n of $)if(this.board.pieces(n,"king").intersects(l.center()))return{winner:n}}},dt=class extends ee{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=xe.default()}setupUnchecked(t){var n;super.setupUnchecked(t),this.remainingChecks=((n=t.remainingChecks)===null||n===void 0?void 0:n.clone())||xe.default()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks){for(let n of $)if(this.remainingChecks[n]<=0)return{winner:n}}}},Yi=()=>{let e=he.empty();return e.occupied=new l(65535,0),e.promoted=l.empty(),e.white=new l(61680,0),e.black=new l(3855,0),e.pawn=l.empty(),e.knight=new l(6168,0),e.bishop=new l(9252,0),e.rook=new l(16962,0),e.queen=new l(129,0),e.king=new l(33024,0),e},ft=class extends ee{constructor(){super("racingkings")}reset(){this.board=Yi(),this.pockets=void 0,this.turn="white",this.castles=ce.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){super.setupUnchecked(t),this.castles=ce.empty()}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?m.err(new D(q.Variant)):super.validate()}dests(t,n){if(n=n||this.ctx(),t===n.king)return super.dests(t,n);let r=l.empty();for(let i of super.dests(t,n)){let o={from:t,to:i},s=this.clone();s.play(o),s.isCheck()||(r=r.with(i))}return r}hasInsufficientMaterial(t){return!1}isVariantEnd(){let t=l.fromRank(7),n=this.board.king.intersect(t);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;let r=this.board.kingOf("black");if(k(r)){let i=this.board.occupied.without(r);for(let o of ae(r).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",i).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;let n=l.fromRank(7),r=this.board.pieces("black","king").intersects(n),i=this.board.pieces("white","king").intersects(n);return r&&!i?{winner:"black"}:i&&!r?{winner:"white"}:{winner:void 0}}},Zi=()=>{let e=he.empty();return e.occupied=new l(4294967295,4294901862),e.promoted=l.empty(),e.white=new l(4294967295,102),e.black=new l(0,4294901760),e.pawn=new l(4294967295,16711782),e.knight=new l(0,1107296256),e.bishop=new l(0,603979776),e.rook=new l(0,2164260864),e.queen=new l(0,134217728),e.king=new l(0,268435456),e},pt=class extends ee{constructor(){super("horde")}reset(){this.board=Zi(),this.pockets=void 0,this.turn="white",this.castles=ce.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){let t=new this;return t.reset(),t}static fromSetup(t){let n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return m.err(new D(q.Empty));if(this.board.king.size()!==1)return m.err(new D(q.Kings));let t=this.board.kingOf(M(this.turn));if(k(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return m.err(new D(q.OppositeCheck));for(let n of $){let r=this.board.pieces(n,"king").isEmpty()?l.backrank(M(n)):l.backranks();if(this.board.pieces(n,"pawn").intersects(r))return m.err(new D(q.PawnsOnBackrank))}return m.ok(void 0)}hasInsufficientMaterial(t){if(this.board.pieces(t,"king").nonEmpty())return!1;let n=b=>b==="light"?"dark":"light",r=b=>b==="light"?l.lightSquares():l.darkSquares(),i=b=>{let h=this.board.pieces(b,"bishop");return h.intersects(l.darkSquares())&&h.intersects(l.lightSquares())},o=de.fromBoard(this.board,t),s=b=>r(b).intersect(this.board.pieces(t,"bishop")).size(),a=s("light")>=1?"light":"dark",u=o.pawn+o.knight+o.rook+o.queen+Math.min(s("dark"),2)+Math.min(s("light"),2),c=de.fromBoard(this.board,M(t)),p=b=>r(b).intersect(this.board.pieces(M(t),"bishop")).size(),f=c.size(),S=b=>f-b;if(u===0)return!0;if(u>=4||(o.pawn>=1||o.queen>=1)&&u>=2||o.rook>=1&&u>=2&&!(u===2&&o.rook===1&&o.bishop===1&&S(p(a))===1))return!1;if(u===1){if(f===1)return!0;if(o.queen===1)return!(c.pawn>=1||c.rook>=1||p("light")>=2||p("dark")>=2);if(o.pawn===1){let b=this.board.pieces(t,"pawn").last(),h=this.clone();h.board.set(b,{color:t,role:"queen"});let d=this.clone();return d.board.set(b,{color:t,role:"knight"}),h.hasInsufficientMaterial(t)&&d.hasInsufficientMaterial(t)}else{if(o.rook===1)return!(c.pawn>=2||c.rook>=1&&c.pawn>=1||c.rook>=1&&c.knight>=1||c.pawn>=1&&c.knight>=1);if(o.bishop===1)return!(p(n(a))>=2||p(n(a))>=1&&c.pawn>=1||c.pawn>=2);if(o.knight===1)return!(f>=4&&(c.knight>=2||c.pawn>=2||c.rook>=1&&c.knight>=1||c.rook>=1&&c.bishop>=1||c.knight>=1&&c.bishop>=1||c.rook>=1&&c.pawn>=1||c.knight>=1&&c.pawn>=1||c.bishop>=1&&c.pawn>=1||i(M(t))&&c.pawn>=1)&&(p("dark")<2||S(p("dark"))>=3)&&(p("light")<2||S(p("light"))>=3))}}else{if(u===2)return f===1?!0:o.knight===2?c.pawn+c.bishop+c.knight<1:i(t)?!(c.pawn>=1||c.bishop>=1||c.knight>=1&&c.rook+c.queen>=1):o.bishop>=1&&o.knight>=1?!(c.pawn>=1||p(n(a))>=1||S(p(a))>=3):!(c.pawn>=1&&p(n(a))>=1||c.pawn>=1&&c.knight>=1||p(n(a))>=1&&c.knight>=1||p(n(a))>=2||c.knight>=2||c.pawn>=2);if(u===3)return o.knight===2&&o.bishop===1||o.knight===3||i(t)?!1:f===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}},Wn=e=>{switch(e){case"chess":return Fe.default();case"antichess":return ut.default();case"atomic":return lt.default();case"horde":return pt.default();case"racingkings":return ft.default();case"kingofthehill":return ht.default();case"3check":return dt.default();case"crazyhouse":return ct.default()}},Un=(e,t)=>{switch(e){case"chess":return Fe.fromSetup(t);case"antichess":return ut.fromSetup(t);case"atomic":return lt.fromSetup(t);case"horde":return pt.fromSetup(t);case"racingkings":return ft.fromSetup(t);case"kingofthehill":return ht.fromSetup(t);case"3check":return dt.fromSetup(t);case"crazyhouse":return ct.fromSetup(t)}};var Xi=(e=Jt)=>({headers:e(),moves:new He}),He=class{constructor(){this.children=[]}*mainlineNodes(){let t=this;for(;t.children.length;){let n=t.children[0];yield n,t=n}}*mainline(){for(let t of this.mainlineNodes())yield t.data}end(){let t=this;for(;t.children.length;)t=t.children[0];return t}},mt=class extends He{constructor(t){super(),this.data=t}};var Yn=(e,t,n)=>{let r=new He,i=[{before:e,after:r,ctx:t}],o;for(;o=i.pop();)for(let s=0;s<o.before.children.length;s++){let a=s<o.before.children.length-1?o.ctx.clone():o.ctx,u=o.before.children[s],c=n(a,u.data,s);if(k(c)){let p=new mt(c);o.after.children.push(p),i.push({before:u,after:p,ctx:a})}}return r};var Ji=e=>e?e.winner==="white"?"1-0":e.winner==="black"?"0-1":"1/2-1/2":"*",eo=e=>e==="1-0"||e==="1\u20130"||e==="1\u20140"?{winner:"white"}:e==="0-1"||e==="0\u20131"||e==="0\u20141"?{winner:"black"}:e==="1/2-1/2"||e==="1/2\u20131/2"||e==="1/2\u20141/2"?{winner:void 0}:void 0;var Jt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]);var jn="\uFEFF",Yt=e=>/^\s*$/.test(e),Zt=e=>e.startsWith("%"),Qt=class extends Error{},Xt=class{constructor(t,n=Jt,r=1e6){this.emitGame=t,this.initHeaders=n,this.maxBudget=r,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Xi(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(t){if(this.budget-=t,this.budget<0)throw new Qt("ERR_PGN_BUDGET")}parse(t,n){if(!(this.budget<0))try{let r=0;for(;;){let i=t.indexOf(`
`,r);if(i===-1)break;let o=i>r&&t[i-1]==="\r"?i-1:i;this.consumeBudget(i-r),this.lineBuf.push(t.slice(r,o)),r=i+1,this.handleLine()}this.consumeBudget(t.length-r),this.lineBuf.push(t.slice(r)),n?.stream||(this.handleLine(),this.emit(void 0))}catch(r){this.emit(r)}}handleLine(){let t=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(jn)&&(n=n.slice(jn.length)),this.state=1;case 1:if(Yt(n)||Zt(n))return;this.found=!0,this.state=2;case 2:{if(Zt(n))return;let r=!0;for(;r;)r=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(i,o,s)=>(this.consumeBudget(200),this.handleHeader(o,s.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),r=!0,t=!1,""));if(Yt(n))return;this.state=3}case 3:{if(t){if(Zt(n))return;if(Yt(n))return this.emit(void 0)}let r=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g,i;for(;i=r.exec(n);){let o=this.stack[this.stack.length-1],s=i[0];if(s===";")return;if(s.startsWith("$"))this.handleNag(parseInt(s.slice(1),10));else if(s==="!")this.handleNag(1);else if(s==="?")this.handleNag(2);else if(s==="!!")this.handleNag(3);else if(s==="??")this.handleNag(4);else if(s==="!?")this.handleNag(5);else if(s==="?!")this.handleNag(6);else if(s==="1-0"||s==="1\u20130"||s==="1\u20140"||s==="0-1"||s==="0\u20131"||s==="0\u20141"||s==="1/2-1/2"||s==="1/2\u20131/2"||s==="1/2\u20141/2"||s==="*")this.stack.length===1&&s!=="*"&&this.handleHeader("Result",s);else if(s==="(")this.consumeBudget(100),this.stack.push({parent:o.parent,root:!1});else if(s===")")this.stack.length>1&&this.stack.pop();else if(s==="{"){let a=r.lastIndex,u=n[a]===" "?a+1:a;n=n.slice(u),this.state=4;continue e}else this.consumeBudget(100),s.startsWith("O")||s.startsWith("0")||s.startsWith("o")?s=s.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(s==="Z0"||s==="0000"||s==="@@@@")&&(s="--"),o.node&&(o.parent=o.node),o.node=new mt({san:s,startingComments:o.startingComments}),o.startingComments=void 0,o.root=!1,o.parent.children.push(o.node)}return}case 4:{let r=n.indexOf("}");if(r===-1){this.commentBuf.push(n);return}else{let i=r>0&&n[r-1]===" "?r-1:r;this.commentBuf.push(n.slice(0,i)),this.handleComment(),n=n.slice(r),this.state=3,t=!1}}}}handleHeader(t,n){this.game.headers.set(t,t==="Result"?Ji(eo(n)):n)}handleNag(t){var n;this.consumeBudget(50);let r=this.stack[this.stack.length-1];r.node&&((n=r.node.data).nags||(n.nags=[]),r.node.data.nags.push(t))}handleComment(){var t,n;this.consumeBudget(100);let r=this.stack[this.stack.length-1],i=this.commentBuf.join(`
`);this.commentBuf=[],r.node?((t=r.node.data).comments||(t.comments=[]),r.node.data.comments.push(i)):r.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(i)):(r.startingComments||(r.startingComments=[]),r.startingComments.push(i))}emit(t){if(this.state===4&&this.handleComment(),t)return this.emitGame(this.game,t);this.found&&this.emitGame(this.game,void 0),this.resetGame()}},en=(e,t=Jt)=>{let n=[];return new Xt(r=>n.push(r),t,NaN).parse(e),n},to=e=>{switch((e||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}};var Zn=e=>{let t=to(e.get("Variant"));if(!t)return m.err(new D(q.Variant));let n=e.get("FEN");return n?$n(n).chain(r=>Un(t,r)):m.ok(Wn(t))};function no(e){switch(e){case"G":return"green";case"R":return"red";case"Y":return"yellow";case"B":return"blue";default:return}}var ro=e=>{let t=no(e.slice(0,1)),n=ue(e.slice(1,3)),r=ue(e.slice(3,5));if(!(!t||!k(n))){if(e.length===3)return{color:t,from:n,to:n};if(e.length===5&&k(r))return{color:t,from:n,to:r}}};var Qn=e=>{let t,n,r,i=[];return{text:e.replace(/\s?\[%(emt|clk)\s(\d{1,5}):(\d{1,2}):(\d{1,2}(?:\.\d{0,3})?)\]\s?/g,(s,a,u,c,p)=>{let f=parseInt(u,10)*3600+parseInt(c,10)*60+parseFloat(p);return a==="emt"?t=f:a==="clk"&&(n=f),"  "}).replace(/\s?\[%(?:csl|cal)\s([RGYB][a-h][1-8](?:[a-h][1-8])?(?:,[RGYB][a-h][1-8](?:[a-h][1-8])?)*)\]\s?/g,(s,a)=>{for(let u of a.split(","))i.push(ro(u));return"  "}).replace(/\s?\[%eval\s(?:#([+-]?\d{1,5})|([+-]?(?:\d{1,5}|\d{0,5}\.\d{1,2})))(?:,(\d{1,5}))?\]\s?/g,(s,a,u,c)=>{let p=c&&parseInt(c,10);return r=a?{mate:parseInt(a,10),depth:p}:{pawns:parseFloat(u),depth:p},"  "}).trim(),shapes:i,emt:t,clock:n,evaluation:r}};function tn(e){return t=>e&&e(t)||oo(t)}var oo=e=>so[e],so={flipTheBoard:"Flip the board",analysisBoard:"Analysis board",practiceWithComputer:"Practice with computer",getPgn:"Get PGN",download:"Download",viewOnLichess:"View on Lichess",viewOnSite:"View on site"};var Xn=["white","black"];var Ae=["a","b","c","d","e","f","g","h"],De=["1","2","3","4","5","6","7","8"];var er=[...De].reverse(),gt=Array.prototype.concat(...Ae.map(e=>De.map(t=>e+t))),V=e=>gt[8*e[0]+e[1]],O=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],tr=e=>{if(e)return e[1]==="@"?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},kt=gt.map(O);function nr(e){let t,n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}var rr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},bt=e=>e==="white"?"black":"white",Se=(e,t)=>{let n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},$e=(e,t)=>e.role===t.role&&e.color===t.color,Ce=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],Z=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},nn=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},Ve=(e,t)=>{e.style.visibility=t?"visible":"hidden"},le=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},wt=e=>e.button===2,Q=(e,t)=>{let n=document.createElement(e);return t&&(n.className=t),n};function vt(e,t,n){let r=O(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}var te=class e{constructor(t){this.path=t;this.size=()=>this.path.length/2;this.head=()=>this.path.slice(0,2);this.tail=()=>new e(this.path.slice(2));this.init=()=>new e(this.path.slice(0,-2));this.last=()=>this.path.slice(-2);this.empty=()=>this.path=="";this.contains=t=>this.path.startsWith(t.path);this.isChildOf=t=>this.init()===t;this.append=t=>new e(this.path+t);this.equals=t=>this.path==t.path}static{this.root=new e("")}};var yt=class{constructor(t,n,r,i){this.initial=t;this.moves=n;this.players=r;this.metadata=i;this.nodeAt=t=>ir(this.moves,t);this.dataAt=t=>{let n=this.nodeAt(t);return n?co(n)?n.data:this.initial:void 0};this.title=()=>this.players.white.name?[this.players.white.title,this.players.white.name,"vs",this.players.black.title,this.players.black.name].filter(t=>t&&!!t.trim()).join("_").replace(" ","-"):"lichess-pgn-viewer";this.pathAtMainlinePly=t=>t==0?te.root:this.mainline[Math.max(0,Math.min(this.mainline.length-1,t=="last"?9999:t-1))]?.path||te.root;this.hasPlayerName=()=>!!(this.players.white?.name||this.players.black?.name);this.mainline=Array.from(this.moves.mainline())}},ao=(e,t)=>e.children.find(n=>n.data.path.last()==t),ir=(e,t)=>{if(t.empty())return e;let n=ao(e,t.head());return n?ir(n,t.tail()):void 0},co=e=>"data"in e,or=e=>"uci"in e;var rn=class e{constructor(t,n,r){this.pos=t;this.path=n;this.clocks=r;this.clone=()=>new e(this.pos.clone(),this.path,{...this.clocks})}},on=e=>{let t=e.map(Qn),n=r=>r.reduce((i,o)=>typeof o==null?i:o,void 0);return{texts:t.map(r=>r.text).filter(r=>!!r),shapes:t.flatMap(r=>r.shapes),clock:n(t.map(r=>r.clock)),emt:n(t.map(r=>r.emt))}},sr=(e,t=!1)=>{let n=en(e)[0]||en("*")[0],r=Zn(n.headers).unwrap(),i=at(r.toSetup()),o=on(n.comments||[]),s=new Map(Array.from(n.headers,([f,S])=>[f.toLowerCase(),S])),a=fo(s,t),u={fen:i,turn:r.turn,check:r.isCheck(),pos:r.clone(),comments:o.texts,shapes:o.shapes,clocks:{white:a.timeControl?.initial||o.clock,black:a.timeControl?.initial||o.clock}},c=lo(r,n.moves,a),p=ho(s,a);return new yt(u,c,p,a)},lo=(e,t,n)=>Yn(t,new rn(e,te.root,{}),(r,i,o)=>{let s=Gn(r.pos,i.san);if(!s)return;let a=In(s),u=r.path.append(a),c=Vn(r.pos,s);r.path=u;let p=r.pos.toSetup(),f=on(i.comments||[]),S=on(i.startingComments||[]),b=[...f.shapes,...S.shapes],h=(p.fullmoves-1)*2+(r.pos.turn==="white"?0:1),d=r.clocks=uo(r.clocks,r.pos.turn,f.clock);return h<2&&n.timeControl&&(d={white:n.timeControl.initial,black:n.timeControl.initial,...d}),{path:u,ply:h,move:s,san:c,uci:Lt(s),fen:at(r.pos.toSetup()),turn:r.pos.turn,check:r.pos.isCheck(),comments:f.texts,startingComments:S.texts,nags:i.nags||[],shapes:b,clocks:d,emt:f.emt}}),uo=(e,t,n)=>t=="white"?{...e,black:n}:{...e,white:n};function ho(e,t){let n=(i,o)=>{let s=e.get(`${i}${o}`);return s=="?"||s==""?void 0:s},r=i=>{let o=n(i,"");return{name:o,title:n(i,"title"),rating:parseInt(n(i,"elo")||"")||void 0,isLichessUser:t.isLichess&&!!o?.match(/^[a-z0-9][a-z0-9_-]{0,28}[a-z0-9]$/i)}};return{white:r("white"),black:r("black")}}function fo(e,t){let n=e.get("chapterurl")||e.get("gameurl")||e.get("source")||e.get("site"),r=e.get("timecontrol")?.split("+").map(s=>parseInt(s)),i=r&&r[0]?{initial:r[0],increment:r[1]||0}:void 0,o=e.get("orientation");return{externalLink:n&&n.match(/^https?:\/\//)?n:void 0,isLichess:!!(t&&n?.startsWith(t)),timeControl:i,orientation:o==="white"||o==="black"?o:void 0,result:e.get("result")}}var We=class{constructor(t,n){this.opts=t;this.redraw=n;this.flipped=!1;this.pane="board";this.autoScrollRequested=!1;this.curNode=()=>this.game.nodeAt(this.path)||this.game.moves;this.curData=()=>this.game.dataAt(this.path)||this.game.initial;this.goTo=(t,n=!0)=>{let r=t=="first"?te.root:t=="prev"?this.path.init():t=="next"?this.game.nodeAt(this.path)?.children[0]?.data.path:this.game.pathAtMainlinePly("last");this.toPath(r||this.path,n)};this.canGoTo=t=>t=="prev"||t=="first"?!this.path.empty():!!this.curNode().children[0];this.toPath=(t,n=!0)=>{this.path=t,this.pane="board",this.autoScrollRequested=!0,this.redrawGround(),this.redraw(),n&&this.focus()};this.focus=()=>this.div?.focus();this.toggleMenu=()=>{this.pane=this.pane=="board"?"menu":"board",this.redraw()};this.togglePgn=()=>{this.pane=this.pane=="pgn"?"board":"pgn",this.redraw()};this.orientation=()=>{let t=this.opts.orientation||"white";return this.flipped?M(t):t};this.flip=()=>{this.flipped=!this.flipped,this.pane="board",this.redrawGround(),this.redraw()};this.cgState=()=>{let t=this.curData(),n=or(t)?tr(t.uci):this.opts.chessground?.lastMove;return{fen:t.fen,orientation:this.orientation(),check:t.check,lastMove:n,turnColor:t.turn}};this.analysisUrl=()=>this.game.metadata.isLichess&&this.game.metadata.externalLink||`https://lichess.org/analysis/${this.curData().fen.replace(" ","_")}?color=${this.orientation()}`;this.practiceUrl=()=>`${this.analysisUrl()}#practice`;this.setGround=t=>{this.ground=t,this.redrawGround()};this.redrawGround=()=>this.withGround(t=>{t.set(this.cgState()),t.setShapes(this.curData().shapes.map(n=>({orig:j(n.from),dest:j(n.to),brush:n.color})))});this.withGround=t=>this.ground&&t(this.ground);this.game=sr(t.pgn,t.lichess),t.orientation=t.orientation||this.game.metadata.orientation,this.translate=tn(t.translate),this.path=this.game.pathAtMainlinePly(t.initialPly)}};var _e=(e,t)=>Math.abs(e-t),po=e=>(t,n,r,i)=>_e(t,r)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===r:i===n-1||n>=6&&i===n-2&&t===r),sn=(e,t,n,r)=>{let i=_e(e,n),o=_e(t,r);return i===1&&o===2||i===2&&o===1},ar=(e,t,n,r)=>_e(e,n)===_e(t,r),cr=(e,t,n,r)=>e===n||t===r,an=(e,t,n,r)=>ar(e,t,n,r)||cr(e,t,n,r),mo=(e,t,n)=>(r,i,o,s)=>_e(r,o)<2&&_e(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(r===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function go(e,t){let n=t==="white"?"1":"8",r=[];for(let[i,o]of e)i[1]===n&&o.color===t&&o.role==="rook"&&r.push(O(i)[0]);return r}function cn(e,t,n){let r=e.get(t);if(!r)return[];let i=O(t),o=r.role,s=o==="pawn"?po(r.color):o==="knight"?sn:o==="bishop"?ar:o==="rook"?cr:o==="queen"?an:mo(r.color,go(e,r.color),n);return kt.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&s(i[0],i[1],a[0],a[1])).map(V)}function W(e,...t){e&&setTimeout(()=>e(...t),1)}function lr(e){e.orientation=bt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function ur(e,t){for(let[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function hr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function ko(e,t,n,r){re(e),e.premovable.current=[t,n],W(e.premovable.events.set,t,n,r)}function ne(e){e.premovable.current&&(e.premovable.current=void 0,W(e.premovable.events.unset))}function bo(e,t,n){ne(e),e.predroppable.current={role:t,key:n},W(e.predroppable.events.set,t,n)}function re(e){let t=e.predroppable;t.current&&(t.current=void 0,W(t.events.unset))}function wo(e,t,n){if(!e.autoCastle)return!1;let r=e.pieces.get(t);if(!r||r.role!=="king")return!1;let i=O(t),o=O(n);if(i[1]!==0&&i[1]!==7||i[1]!==o[1])return!1;i[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=V([7,o[1]]):o[0]===2&&(n=V([0,o[1]])));let s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<o[0]?(e.pieces.set(V([6,o[1]]),r),e.pieces.set(V([5,o[1]]),s)):(e.pieces.set(V([2,o[1]]),r),e.pieces.set(V([3,o[1]]),s)),!0)}function ln(e,t,n){let r=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!r)return!1;let o=i&&i.color!==r.color?i:void 0;return n===e.selected&&G(e),W(e.events.move,t,n,o),wo(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,W(e.events.change),o||!0}function xt(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return W(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,W(e.events.change),e.movable.dests=void 0,e.turnColor=bt(e.turnColor),!0}function dr(e,t,n){let r=ln(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=bt(e.turnColor),e.animation.current=void 0),r}function un(e,t,n){if(Ct(e,t,n)){let r=dr(e,t,n);if(r){let i=e.hold.stop();G(e);let o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(o.captured=r),W(e.movable.events.after,t,n,o),!0}}else if(yo(e,t,n))return ko(e,t,n,{ctrlKey:e.stats.ctrlKey}),G(e),!0;return G(e),!1}function St(e,t,n,r){let i=e.pieces.get(t);i&&(vo(e,t,n)||r)?(e.pieces.delete(t),xt(e,i,n,r),W(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&xo(e,t,n)?bo(e,i.role,n):(ne(e),re(e)),e.pieces.delete(t),G(e)}function Ue(e,t,n){if(W(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){G(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&un(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(fr(e,t)||dn(e,t))&&(hn(e,t),e.hold.start())}function hn(e,t){e.selected=t,dn(e,t)?e.premovable.customDests||(e.premovable.dests=cn(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function fr(e,t){let n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}var Ct=(e,t,n)=>{var r,i;return t!==n&&fr(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(n)))};function vo(e,t,n){let r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function dn(e,t){let n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function yo(e,t,n){var r,i;let o=(i=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&i!==void 0?i:cn(e.pieces,t,e.premovable.castle);return t!==n&&dn(e,t)&&o.includes(n)}function xo(e,t,n){let r=e.pieces.get(t),i=e.pieces.get(n);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function pr(e,t){let n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function mr(e){let t=e.premovable.current;if(!t)return!1;let n=t[0],r=t[1],i=!1;if(Ct(e,n,r)){let o=dr(e,n,r);if(o){let s={premove:!0};o!==!0&&(s.captured=o),W(e.movable.events.after,n,r,s),i=!0}}return ne(e),i}function gr(e,t){let n=e.predroppable.current,r=!1;if(!n)return!1;if(t(n)){let i={role:n.role,color:e.movable.color};xt(e,i,n.key)&&(W(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return re(e),r}function je(e){ne(e),re(e),G(e)}function fn(e){e.movable.color=e.movable.dests=e.animation.current=void 0,je(e)}function ie(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?V([r,i]):void 0}function kr(e,t,n,r){let i=O(e),o=kt.filter(c=>an(i[0],i[1],c[0],c[1])||sn(i[0],i[1],c[0],c[1])),a=o.map(c=>vt(V(c),n,r)).map(c=>Se(t,c)),[,u]=a.reduce((c,p,f)=>c[0]<p?c:[p,f],[a[0],0]);return V(o[u])}var L=e=>e.orientation==="white";var mn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",So={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Co={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Pt(e){e==="start"&&(e=mn);let t=new Map,n=7,r=0;for(let i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{let o=t.get(V([r-1,n]));o&&(o.promoted=!0);break}default:{let o=i.charCodeAt(0);if(o<57)r+=o-48;else{let s=i.toLowerCase();t.set(V([r,n]),{role:So[s],color:i===s?"black":"white"}),++r}}}return t}function br(e){return er.map(t=>Ae.map(n=>{let r=e.get(n+t);if(r){let i=Co[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function gn(e,t){t.animation&&(kn(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Mt(e,t){var n,r,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),kn(e,t),t.fen&&(e.pieces=Pt(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&hr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&hn(e,e.selected),gn(e,t),!e.movable.rookCastle&&e.movable.dests){let o=e.movable.color==="white"?"1":"8",s="e"+o,a=e.movable.dests.get(s),u=e.pieces.get(s);if(!a||!u||u.role!=="king")return;e.movable.dests.set(s,a.filter(c=>!(c==="a"+o&&a.includes("c"+o))&&!(c==="h"+o&&a.includes("g"+o))))}}function kn(e,t){for(let n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&wr(e[n])&&wr(t[n])?kn(e[n],t[n]):e[n]=t[n])}function wr(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var fe=(e,t)=>t.animation.enabled?Ao(e,t):pe(e,t);function pe(e,t){let n=e(t);return t.dom.redraw(),n}var bn=(e,t)=>({key:e,pos:O(e),piece:t}),Mo=(e,t)=>t.sort((n,r)=>Se(e.pos,n.pos)-Se(e.pos,r.pos))[0];function Eo(e,t){let n=new Map,r=[],i=new Map,o=[],s=[],a=new Map,u,c,p;for(let[f,S]of e)a.set(f,bn(f,S));for(let f of gt)u=t.pieces.get(f),c=a.get(f),u?c?$e(u,c.piece)||(o.push(c),s.push(bn(f,u))):s.push(bn(f,u)):c&&o.push(c);for(let f of s)c=Mo(f,o.filter(S=>$e(f.piece,S.piece))),c&&(p=[c.pos[0]-f.pos[0],c.pos[1]-f.pos[1]],n.set(f.key,p.concat(p)),r.push(c.key));for(let f of o)r.includes(f.key)||i.set(f.key,f.piece);return{anims:n,fadings:i}}function vr(e,t){let n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}let r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{let i=_o(r);for(let o of n.plan.anims.values())o[2]=o[0]*i,o[3]=o[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>vr(e,o))}}function Ao(e,t){let n=new Map(t.pieces),r=e(t),i=Eo(n,t);if(i.anims.size||i.fadings.size){let o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},o||vr(t,performance.now())}else t.dom.redraw();return r}var _o=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var No=["green","red","blue","yellow"];function yr(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):je(e);let n=le(t),r=ie(n,L(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Ro(t),snapToValidMove:e.drawable.defaultSnapToValidMove},xr(e))}function xr(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let n=ie(t.pos,L(e),e.dom.bounds());n||(t.snapToValidMove=!1);let r=t.snapToValidMove?kr(t.orig,t.pos,L(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),xr(e)}})}function Sr(e,t){e.drawable.current&&(e.drawable.current.pos=le(t))}function Cr(e){let t=e.drawable.current;t&&(t.mouseSq&&Oo(e.drawable,t),wn(e))}function wn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Pr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Mr(e.drawable))}function Ro(e){var t;let n=(e.shiftKey||e.ctrlKey)&&wt(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return No[(n?1:0)+(r?2:0)]}function Oo(e,t){let n=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(i=>!n(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Mr(e)}function Mr(e){e.onChange&&e.onChange(e.shapes)}function Er(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let n=e.dom.bounds(),r=le(t),i=ie(r,L(e),n);if(!i)return;let o=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Pr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||qo(e,r)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Ct(e,e.selected,i)?fe(f=>Ue(f,i),e):Ue(e,i);let c=e.selected===i,p=Or(e,i);if(o&&p&&c&&pr(e,i)){e.draggable.current={orig:i,piece:o,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");let f=e.dom.elements.ghost;f&&(f.className=`ghost ${o.color} ${o.role}`,Z(f,Ce(n)(O(i),L(e))),Ve(f,!0)),vn(e)}else a&&ne(e),u&&re(e);e.dom.redraw()}function qo(e,t){let n=L(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(let o of e.pieces.keys()){let s=vt(o,n,r);if(Se(s,t)<=i)return!0}return!1}function Ar(e,t,n,r){let i="a0";e.pieces.set(i,t),e.dom.redraw();let o=le(n);e.draggable.current={orig:i,piece:t,origPos:o,pos:o,started:!0,element:()=>Or(e,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},vn(e)}function vn(e){requestAnimationFrame(()=>{var t;let n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);let r=e.pieces.get(n.orig);if(!r||!$e(r,n.piece))Ne(e);else if(!n.started&&Se(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){let o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}let i=e.dom.bounds();Z(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ie(n.pos,L(e),i))}vn(e)})}function _r(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=le(t))}function Nr(e,t){let n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}ne(e),re(e);let r=le(t)||n.pos,i=ie(r,L(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?St(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,un(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),W(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?G(e):e.selectable.enabled||G(e),Rr(e),e.draggable.current=void 0,e.dom.redraw()}function Ne(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),Rr(e),e.dom.redraw())}function Rr(e){let t=e.dom.elements;t.ghost&&Ve(t.ghost,!1)}function Or(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function qr(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Tr(e,2),setTimeout(()=>Tr(e,void 0),120)},120)}function Tr(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Dr(e,t){function n(){lr(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),gn(e,r),(r.fen?fe:pe)(i=>Mt(i,r),e)},state:e,getFen:()=>br(e.pieces),toggleOrientation:n,setPieces(r){fe(i=>ur(i,r),e)},selectSquare(r,i){r?fe(o=>Ue(o,r,i),e):e.selected&&(G(e),e.dom.redraw())},move(r,i){fe(o=>ln(o,r,i),e)},newPiece(r,i){fe(o=>xt(o,r,i),e)},playPremove(){if(e.premovable.current){if(fe(mr,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){let i=gr(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){pe(ne,e)},cancelPredrop(){pe(re,e)},cancelMove(){pe(r=>{je(r),Ne(r)},e)},stop(){pe(r=>{fn(r),Ne(r)},e)},explode(r){qr(e,r)},setAutoShapes(r){pe(i=>i.drawable.autoShapes=r,e)},setShapes(r){pe(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return ie(r,L(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,o){Ar(e,r,i,o)},destroy(){fn(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Br(){return{pieces:Pt(mn),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:rr()}}var Lr={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function zr(){let e=I("defs"),t=H(I("filter"),{id:"cg-filter-blur"});return t.appendChild(H(I("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Fr(e,t,n){var r;let i=e.drawable,o=i.current,s=o&&o.mouseSq?o:void 0,a=new Map,u=e.dom.bounds(),c=i.autoShapes.filter(b=>!b.piece);for(let b of i.shapes.concat(c).concat(s?[s]:[])){if(!b.dest)continue;let h=(r=a.get(b.dest))!==null&&r!==void 0?r:new Set,d=_t(At(O(b.orig),e.orientation),u),w=_t(At(O(b.dest),e.orientation),u);h.add(xn(d,w)),a.set(b.dest,h)}let p=i.shapes.concat(c).map(b=>({shape:b,current:!1,hash:Ir(b,yn(b.dest,a),!1,u)}));s&&p.push({shape:s,current:!0,hash:Ir(s,yn(s.dest,a),!0,u)});let f=p.map(b=>b.hash).join(";");if(f===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=f;let S=t.querySelector("defs");Bo(i,p,S),Lo(p,t.querySelector("g"),n.querySelector("g"),b=>zo(e,b,i.brushes,a,u))}function Bo(e,t,n){var r;let i=new Map,o;for(let u of t.filter(c=>c.shape.dest&&c.shape.brush))o=Hr(e.brushes[u.shape.brush],u.shape.modifiers),!((r=u.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(Et(o).key,Et(o)),i.set(o.key,o);let s=new Set,a=n.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(let[u,c]of i.entries())s.has(u)||n.appendChild($o(c))}function Lo(e,t,n,r){let i=new Map;for(let o of e)i.set(o.hash,!1);for(let o of[t,n]){let s=[],a=o.firstElementChild,u;for(;a;)u=a.getAttribute("cgHash"),i.has(u)?i.set(u,!0):s.push(a),a=a.nextElementSibling;for(let c of s)o.removeChild(c)}for(let o of e.filter(s=>!i.get(s.hash)))for(let s of r(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Ir({orig:e,dest:t,brush:n,piece:r,modifiers:i,customSvg:o,label:s},a,u,c){var p,f;return[c.width,c.height,u,e,t,n,a&&"-",r&&Io(r),i&&Ko(i),o&&`custom-${Kr(o.html)},${(f=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&f!==void 0?f:"o"}`,s&&`label-${Kr(s.text)}`].filter(S=>S).join(",")}function Io(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Ko(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Kr(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function zo(e,{shape:t,current:n,hash:r},i,o,s){var a,u;let c=_t(At(O(t.orig),e.orientation),s),p=t.dest?_t(At(O(t.dest),e.orientation),s):c,f=t.brush&&Hr(i[t.brush],t.modifiers),S=o.get(t.dest),b=[];if(f){let h=H(I("g"),{cgHash:r});b.push({el:h}),c[0]!==p[0]||c[1]!==p[1]?h.appendChild(Ho(t,f,c,p,n,yn(t.dest,o))):h.appendChild(Fo(i[t.brush],c,n,s))}if(t.label){let h=t.label;(a=h.fill)!==null&&a!==void 0||(h.fill=t.brush&&i[t.brush].color);let d=t.brush?void 0:"tr";b.push({el:Vo(h,r,c,p,S,d),isCustom:!0})}if(t.customSvg){let h=(u=t.customSvg.center)!==null&&u!==void 0?u:"orig",[d,w]=h==="label"?Vr(c,p,S).map(y=>y-.5):h==="dest"?p:c,g=H(I("g"),{transform:`translate(${d},${w})`,cgHash:r});g.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,b.push({el:g,isCustom:!0})}return b}function Fo(e,t,n,r){let i=Go(),o=(r.width+r.height)/(4*Math.max(r.width,r.height));return H(I("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:$r(e,n),cx:t[0],cy:t[1],r:o-i[1]/2})}function Et(e){return["#ffffff","#fff","white"].includes(e.color)?Lr.hilitePrimary:Lr.hiliteWhite}function Ho(e,t,n,r,i,o){var s;function a(p){var f;let S=Uo(o&&!i),b=r[0]-n[0],h=r[1]-n[1],d=Math.atan2(h,b),w=Math.cos(d)*S,g=Math.sin(d)*S;return H(I("line"),{stroke:p?Et(t).color:t.color,"stroke-width":Wo(t,i)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?Et(t).key:t.key})`,opacity:!((f=e.modifiers)===null||f===void 0)&&f.hilite?1:$r(t,i),x1:n[0],y1:n[1],x2:r[0]-w,y2:r[1]-g})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);let u=I("g"),c=H(I("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(jo(n,r)),c.appendChild(a(!0)),u.appendChild(c),u.appendChild(a(!1)),u}function $o(e){let t=H(I("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(H(I("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Vo(e,t,n,r,i,o){var s;let u=.4*.75**e.text.length,c=Vr(n,r,i),p=o==="tr"?.4:0,f=H(I("g"),{transform:`translate(${c[0]+p},${c[1]-p})`,cgHash:t});f.appendChild(H(I("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));let S=H(I("text"),{"font-size":u,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return S.innerHTML=e.text,f.appendChild(S),f}function At(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function yn(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function I(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function H(e,t){for(let n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function Hr(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function Go(){return[3/64,4/64]}function Wo(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function $r(e,t){return(e.opacity||1)*(t?.9:1)}function Uo(e){return(e?20:10)/64}function _t(e,t){let n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function jo(e,t){let n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return H(I("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function xn(e,t,n=!0){let r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function Yo(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function Vr(e,t,n){let r=Yo(e,t),i=xn(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;let o=xn(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(r-=.4)}return[e[0]-Math.cos(i)*r,e[1]-Math.sin(i)*r].map(o=>o+.5)}function Gr(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let u of Xn)e.classList.toggle("orientation-"+u,t.orientation===u);e.classList.toggle("manipulable",!t.viewOnly);let n=Q("cg-container");e.appendChild(n);let r=Q("cg-board");n.appendChild(r);let i,o,s;if(t.drawable.visible&&(i=H(I("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(zr()),i.appendChild(I("g")),o=H(I("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(I("g")),s=Q("cg-auto-pieces"),n.appendChild(i),n.appendChild(o),n.appendChild(s)),t.coordinates){let u=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){let p=t.orientation==="white"?f=>f+1:f=>8-f;Ae.forEach((f,S)=>n.appendChild(Sn(De.map(b=>f+b),"squares rank"+p(S)+u+c)))}else n.appendChild(Sn(De,"ranks"+u+c)),n.appendChild(Sn(Ae,"files"+u))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=Q("piece","ghost"),Ve(a,!1),n.appendChild(a)),{board:r,container:n,wrap:e,ghost:a,svg:i,customSvg:o,autoPieces:s}}function Sn(e,t){let n=Q("coords",t),r;for(let i of e)r=Q("coord"),r.textContent=i,n.appendChild(r);return n}function Wr(e,t){if(!e.dropmode.active)return;ne(e),re(e);let n=e.dropmode.piece;if(n){e.pieces.set("a0",n);let r=le(t),i=r&&ie(r,L(e),e.dom.bounds());i&&St(e,"a0",i)}e.dom.redraw()}function jr(e,t){let n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;let r=Qo(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function Yr(e,t){let n=[];if("ResizeObserver"in window||n.push(Ye(document.body,"chessground.resize",t)),!e.viewOnly){let r=Ur(e,_r,Sr),i=Ur(e,Nr,Cr);for(let s of["touchmove","mousemove"])n.push(Ye(document,s,r));for(let s of["touchend","mouseup"])n.push(Ye(document,s,i));let o=()=>e.dom.bounds.clear();n.push(Ye(document,"scroll",o,{capture:!0,passive:!0})),n.push(Ye(window,"resize",o,{passive:!0}))}return()=>n.forEach(r=>r())}function Ye(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}var Qo=e=>t=>{e.draggable.current?Ne(e):e.drawable.current?wn(e):t.shiftKey||wt(t)?e.drawable.enabled&&yr(e,t):e.viewOnly||(e.dropmode.active?Wr(e,t):Er(e,t))},Ur=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function Qr(e){let t=L(e),n=Ce(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,a=o?o.plan.fadings:new Map,u=e.draggable.current,c=Jo(e),p=new Set,f=new Set,S=new Map,b=new Map,h,d,w,g,y,A,x,C,P,_;for(d=r.firstChild;d;){if(h=d.cgKey,Jr(d))if(w=i.get(h),y=s.get(h),A=a.get(h),g=d.cgPiece,d.cgDragging&&(!u||u.orig!==h)&&(d.classList.remove("dragging"),Z(d,n(O(h),t)),d.cgDragging=!1),!A&&d.cgFading&&(d.cgFading=!1,d.classList.remove("fading")),w){if(y&&d.cgAnimating&&g===Ze(w)){let v=O(h);v[0]+=y[2],v[1]+=y[3],d.classList.add("anim"),Z(d,n(v,t))}else d.cgAnimating&&(d.cgAnimating=!1,d.classList.remove("anim"),Z(d,n(O(h),t)),e.addPieceZIndex&&(d.style.zIndex=Cn(O(h),t)));g===Ze(w)&&(!A||!d.cgFading)?p.add(h):A&&g===Ze(A)?(d.classList.add("fading"),d.cgFading=!0):Pn(S,g,d)}else Pn(S,g,d);else if(ei(d)){let v=d.className;c.get(h)===v?f.add(h):Pn(b,v,d)}d=d.nextSibling}for(let[v,N]of c)if(!f.has(v)){P=b.get(N),_=P&&P.pop();let T=n(O(v),t);if(_)_.cgKey=v,Z(_,T);else{let R=Q("square",N);R.cgKey=v,Z(R,T),r.insertBefore(R,r.firstChild)}}for(let[v,N]of i)if(y=s.get(v),!p.has(v))if(x=S.get(Ze(N)),C=x&&x.pop(),C){C.cgKey=v,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);let T=O(v);e.addPieceZIndex&&(C.style.zIndex=Cn(T,t)),y&&(C.cgAnimating=!0,C.classList.add("anim"),T[0]+=y[2],T[1]+=y[3]),Z(C,n(T,t))}else{let T=Ze(N),R=Q("piece",T),K=O(v);R.cgPiece=T,R.cgKey=v,y&&(R.cgAnimating=!0,K[0]+=y[2],K[1]+=y[3]),Z(R,n(K,t)),e.addPieceZIndex&&(R.style.zIndex=Cn(K,t)),r.appendChild(R)}for(let v of S.values())Zr(e,v);for(let v of b.values())Zr(e,v)}function Xr(e){let t=L(e),n=Ce(e.dom.bounds()),r=e.dom.elements.board.firstChild;for(;r;)(Jr(r)&&!r.cgAnimating||ei(r))&&Z(r,n(O(r.cgKey),t)),r=r.nextSibling}function Mn(e){var t,n;let r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,o=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*o;i.style.width=s+"px",i.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",a+"px")}var Jr=e=>e.tagName==="PIECE",ei=e=>e.tagName==="SQUARE";function Zr(e,t){for(let n of t)e.dom.elements.board.removeChild(n)}function Cn(e,t){let r=e[1];return`${t?10-r:3+r}`}var Ze=e=>`${e.color} ${e.role}`;function Jo(e){var t,n,r;let i=new Map;if(e.lastMove&&e.highlight.lastMove)for(let a of e.lastMove)me(i,a,"last-move");if(e.check&&e.highlight.check&&me(i,e.check,"check"),e.selected&&(me(i,e.selected,"selected"),e.movable.showDests)){let a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(let c of a)me(i,c,"move-dest"+(e.pieces.has(c)?" oc":""));let u=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(u)for(let c of u)me(i,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}let o=e.premovable.current;if(o)for(let a of o)me(i,a,"current-premove");else e.predroppable.current&&me(i,e.predroppable.current.key,"current-premove");let s=e.exploding;if(s)for(let a of s.keys)me(i,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,u)=>{me(i,u,a)}),i}function me(e,t,n){let r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function Pn(e,t,n){let r=e.get(t);r?r.push(n):e.set(t,[n])}function ti(e,t,n){let r=new Map,i=[];for(let a of e)r.set(a.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),r.has(s)?r.set(s,!0):i.push(o),o=o.nextElementSibling;for(let a of i)t.removeChild(a);for(let a of e)r.get(a.hash)||t.appendChild(n(a))}function ni(e,t){let r=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:ts(i),current:!1}));ti(r,t,i=>es(e,i,e.dom.bounds()))}function ri(e){var t;let n=L(e),r=Ce(e.dom.bounds()),i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)nn(i,r(O(i.cgKey),n),i.cgScale),i=i.nextSibling}function es(e,{shape:t,hash:n},r){var i,o,s;let a=t.orig,u=(i=t.piece)===null||i===void 0?void 0:i.role,c=(o=t.piece)===null||o===void 0?void 0:o.color,p=(s=t.piece)===null||s===void 0?void 0:s.scale,f=Q("piece",`${u} ${c}`);return f.setAttribute("cgHash",n),f.cgKey=a,f.cgScale=p,nn(f,Ce(r)(O(a),L(e)),p),f}var ts=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function ii(e,t){let n=Br();Mt(n,t||{});function r(){let i="dom"in n?n.dom.unbind:void 0,o=Gr(e,n),s=nr(()=>o.board.getBoundingClientRect()),a=p=>{Qr(c),o.autoPieces&&ni(c,o.autoPieces),!p&&o.svg&&Fr(c,o.svg,o.customSvg)},u=()=>{Mn(c),Xr(c),o.autoPieces&&ri(c)},c=n;return c.dom={elements:o,bounds:s,redraw:rs(a),redrawNow:a,unbind:i},c.drawable.prevSvgHash="",Mn(c),a(!1),jr(c,u),i||(c.dom.unbind=Yr(c,u)),c.events.insert&&c.events.insert(o),c}return Dr(r(),r)}function rs(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function is(e,t){return document.createElement(e,t)}function os(e,t,n){return document.createElementNS(e,t,n)}function ss(){return Re(document.createDocumentFragment())}function as(e){return document.createTextNode(e)}function cs(e){return document.createComment(e)}function ls(e,t,n){if(ge(e)){let r=e;for(;r&&ge(r);)r=Re(r).parent;e=r??e}ge(t)&&(t=Re(t,e)),n&&ge(n)&&(n=Re(n).firstChildNode),e.insertBefore(t,n)}function us(e,t){e.removeChild(t)}function hs(e,t){ge(t)&&(t=Re(t,e)),e.appendChild(t)}function oi(e){if(ge(e)){for(;e&&ge(e);)e=Re(e).parent;return e??null}return e.parentNode}function ds(e){var t;if(ge(e)){let n=Re(e),r=oi(n);if(r&&n.lastChildNode){let i=Array.from(r.childNodes),o=i.indexOf(n.lastChildNode);return(t=i[o+1])!==null&&t!==void 0?t:null}return null}return e.nextSibling}function fs(e){return e.tagName}function ps(e,t){e.textContent=t}function ms(e){return e.textContent}function gs(e){return e.nodeType===1}function ks(e){return e.nodeType===3}function bs(e){return e.nodeType===8}function ge(e){return e.nodeType===11}function Re(e,t){var n,r,i;let o=e;return(n=o.parent)!==null&&n!==void 0||(o.parent=t??null),(r=o.firstChildNode)!==null&&r!==void 0||(o.firstChildNode=e.firstChild),(i=o.lastChildNode)!==null&&i!==void 0||(o.lastChildNode=e.lastChild),o}var si={createElement:is,createElementNS:os,createTextNode:as,createDocumentFragment:ss,createComment:cs,insertBefore:ls,removeChild:us,appendChild:hs,parentNode:oi,nextSibling:ds,tagName:fs,setTextContent:ps,getTextContent:ms,isElement:gs,isText:ks,isComment:bs,isDocumentFragment:ge};function Oe(e,t,n,r,i){let o=t===void 0?void 0:t.key;return{sel:e,data:t,children:n,text:r,elm:i,key:o}}var Be=Array.isArray;function Le(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function Nt(e){return e===void 0}function Y(e){return e!==void 0}var En=Oe("",{},[],void 0,void 0);function Qe(e,t){var n,r;let i=e.key===t.key,o=((n=e.data)===null||n===void 0?void 0:n.is)===((r=t.data)===null||r===void 0?void 0:r.is),s=e.sel===t.sel,a=!e.sel&&e.sel===t.sel?typeof e.text==typeof t.text:!0;return s&&i&&o&&a}function ws(){throw new Error("The document fragment is not supported on this platform.")}function vs(e,t){return e.isElement(t)}function ys(e,t){return e.isDocumentFragment(t)}function xs(e,t,n){var r;let i={};for(let o=t;o<=n;++o){let s=(r=e[o])===null||r===void 0?void 0:r.key;s!==void 0&&(i[s]=o)}return i}var Ss=["create","update","remove","destroy","pre","post"];function An(e,t,n){let r={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},i=t!==void 0?t:si;for(let h of Ss)for(let d of e){let w=d[h];w!==void 0&&r[h].push(w)}function o(h){let d=h.id?"#"+h.id:"",w=h.getAttribute("class"),g=w?"."+w.split(" ").join("."):"";return Oe(i.tagName(h).toLowerCase()+d+g,{},[],void 0,h)}function s(h){return Oe(void 0,{},[],void 0,h)}function a(h,d){return function(){if(--d===0){let g=i.parentNode(h);g!==null&&i.removeChild(g,h)}}}function u(h,d){var w,g,y,A;let x,C=h.data;if(C!==void 0){let v=(w=C.hook)===null||w===void 0?void 0:w.init;Y(v)&&(v(h),C=h.data)}let P=h.children,_=h.sel;if(_==="!")Nt(h.text)&&(h.text=""),h.elm=i.createComment(h.text);else if(_==="")h.elm=i.createTextNode(h.text);else if(_!==void 0){let v=_.indexOf("#"),N=_.indexOf(".",v),T=v>0?v:_.length,R=N>0?N:_.length,K=v!==-1||N!==-1?_.slice(0,Math.min(T,R)):_,X=h.elm=Y(C)&&Y(x=C.ns)?i.createElementNS(x,K,C):i.createElement(K,C);for(T<R&&X.setAttribute("id",_.slice(T+1,R)),N>0&&X.setAttribute("class",_.slice(R+1).replace(/\./g," ")),x=0;x<r.create.length;++x)r.create[x](En,h);if(Le(h.text)&&(!Be(P)||P.length===0)&&i.appendChild(X,i.createTextNode(h.text)),Be(P))for(x=0;x<P.length;++x){let Tn=P[x];Tn!=null&&i.appendChild(X,u(Tn,d))}let Xe=h.data.hook;Y(Xe)&&((g=Xe.create)===null||g===void 0||g.call(Xe,En,h),Xe.insert&&d.push(h))}else if(!((y=n?.experimental)===null||y===void 0)&&y.fragments&&h.children){for(h.elm=((A=i.createDocumentFragment)!==null&&A!==void 0?A:ws)(),x=0;x<r.create.length;++x)r.create[x](En,h);for(x=0;x<h.children.length;++x){let v=h.children[x];v!=null&&i.appendChild(h.elm,u(v,d))}}else h.elm=i.createTextNode(h.text);return h.elm}function c(h,d,w,g,y,A){for(;g<=y;++g){let x=w[g];x!=null&&i.insertBefore(h,u(x,A),d)}}function p(h){var d,w;let g=h.data;if(g!==void 0){(w=(d=g?.hook)===null||d===void 0?void 0:d.destroy)===null||w===void 0||w.call(d,h);for(let y=0;y<r.destroy.length;++y)r.destroy[y](h);if(h.children!==void 0)for(let y=0;y<h.children.length;++y){let A=h.children[y];A!=null&&typeof A!="string"&&p(A)}}}function f(h,d,w,g){for(var y,A;w<=g;++w){let x,C,P=d[w];if(P!=null)if(Y(P.sel)){p(P),x=r.remove.length+1,C=a(P.elm,x);for(let v=0;v<r.remove.length;++v)r.remove[v](P,C);let _=(A=(y=P?.data)===null||y===void 0?void 0:y.hook)===null||A===void 0?void 0:A.remove;Y(_)?_(P,C):C()}else P.children?(p(P),f(h,P.children,0,P.children.length-1)):i.removeChild(h,P.elm)}}function S(h,d,w,g){let y=0,A=0,x=d.length-1,C=d[0],P=d[x],_=w.length-1,v=w[0],N=w[_],T,R,K,X;for(;y<=x&&A<=_;)C==null?C=d[++y]:P==null?P=d[--x]:v==null?v=w[++A]:N==null?N=w[--_]:Qe(C,v)?(b(C,v,g),C=d[++y],v=w[++A]):Qe(P,N)?(b(P,N,g),P=d[--x],N=w[--_]):Qe(C,N)?(b(C,N,g),i.insertBefore(h,C.elm,i.nextSibling(P.elm)),C=d[++y],N=w[--_]):Qe(P,v)?(b(P,v,g),i.insertBefore(h,P.elm,C.elm),P=d[--x],v=w[++A]):(T===void 0&&(T=xs(d,y,x)),R=T[v.key],Nt(R)?(i.insertBefore(h,u(v,g),C.elm),v=w[++A]):Nt(T[N.key])?(i.insertBefore(h,u(N,g),i.nextSibling(P.elm)),N=w[--_]):(K=d[R],K.sel!==v.sel?i.insertBefore(h,u(v,g),C.elm):(b(K,v,g),d[R]=void 0,i.insertBefore(h,K.elm,C.elm)),v=w[++A]));A<=_&&(X=w[_+1]==null?null:w[_+1].elm,c(h,X,w,A,_,g)),y<=x&&f(h,d,y,x)}function b(h,d,w){var g,y,A,x,C,P,_,v;let N=(g=d.data)===null||g===void 0?void 0:g.hook;(y=N?.prepatch)===null||y===void 0||y.call(N,h,d);let T=d.elm=h.elm;if(h===d)return;if(d.data!==void 0||Y(d.text)&&d.text!==h.text){(A=d.data)!==null&&A!==void 0||(d.data={}),(x=h.data)!==null&&x!==void 0||(h.data={});for(let X=0;X<r.update.length;++X)r.update[X](h,d);(_=(P=(C=d.data)===null||C===void 0?void 0:C.hook)===null||P===void 0?void 0:P.update)===null||_===void 0||_.call(P,h,d)}let R=h.children,K=d.children;Nt(d.text)?Y(R)&&Y(K)?R!==K&&S(T,R,K,w):Y(K)?(Y(h.text)&&i.setTextContent(T,""),c(T,null,K,0,K.length-1,w)):Y(R)?f(T,R,0,R.length-1):Y(h.text)&&i.setTextContent(T,""):h.text!==d.text&&(Y(R)&&f(T,R,0,R.length-1),i.setTextContent(T,d.text)),(v=N?.postpatch)===null||v===void 0||v.call(N,h,d)}return function(d,w){let g,y,A,x=[];for(g=0;g<r.pre.length;++g)r.pre[g]();for(vs(i,d)?d=o(d):ys(i,d)&&(d=s(d)),Qe(d,w)?b(d,w,x):(y=d.elm,A=i.parentNode(y),u(w,x),A!==null&&(i.insertBefore(A,w.elm,i.nextSibling(y)),f(A,[d],0,0))),g=0;g<x.length;++g)x[g].data.hook.insert(x[g]);for(g=0;g<r.post.length;++g)r.post[g]();return w}}function ci(e,t,n){if(e.ns="http://www.w3.org/2000/svg",n!=="foreignObject"&&t!==void 0)for(let r=0;r<t.length;++r){let i=t[r];if(typeof i=="string")continue;let o=i.data;o!==void 0&&ci(o,i.children,i.sel)}}function E(e,t,n){let r={},i,o,s;if(n!==void 0?(t!==null&&(r=t),Be(n)?i=n:Le(n)?o=n.toString():n&&n.sel&&(i=[n])):t!=null&&(Be(t)?i=t:Le(t)?o=t.toString():t&&t.sel?i=[t]:r=t),i!==void 0)for(s=0;s<i.length;++s)Le(i[s])&&(i[s]=Oe(void 0,void 0,void 0,i[s],void 0));return e.startsWith("svg")&&(e.length===3||e[3]==="."||e[3]==="#")&&ci(r,i,e),Oe(e,r,i,o,void 0)}var Cs="http://www.w3.org/1999/xlink",Ps="http://www.w3.org/2000/xmlns/",Ms="http://www.w3.org/XML/1998/namespace";function li(e,t){let n,r=t.elm,i=e.data.attrs,o=t.data.attrs;if(!(!i&&!o)&&i!==o){i=i||{},o=o||{};for(n in o){let s=o[n];i[n]!==s&&(s===!0?r.setAttribute(n,""):s===!1?r.removeAttribute(n):n.charCodeAt(0)!==120?r.setAttribute(n,s):n.charCodeAt(3)===58?r.setAttributeNS(Ms,n,s):n.charCodeAt(5)===58?n.charCodeAt(1)===109?r.setAttributeNS(Ps,n,s):r.setAttributeNS(Cs,n,s):r.setAttribute(n,s))}for(n in i)n in o||r.removeAttribute(n)}}var _n={create:li,update:li};function ui(e,t){let n,r,i=t.elm,o=e.data.class,s=t.data.class;if(!(!o&&!s)&&o!==s){o=o||{},s=s||{};for(r in o)o[r]&&!Object.prototype.hasOwnProperty.call(s,r)&&i.classList.remove(r);for(r in s)n=s[r],n!==o[r]&&i.classList[n?"add":"remove"](r)}}var Nn={create:ui,update:ui};function hi(e,t,n){for(let r of["touchstart","mousedown"])e.addEventListener(r,i=>{t(i),i.preventDefault(),n&&n()},{passive:!1})}var Rt=(e,t,n,r=!0)=>Ie(i=>i.addEventListener(e,o=>{let s=t(o);return s===!1&&o.preventDefault(),n?.(),s},{passive:r}));function Ie(e){return{insert:t=>e(t.elm)}}function di(e){let t=0;return n=>{t+=n.deltaY*(n.deltaMode?40:1),Math.abs(t)>=4?(e(n,!0),t=0):e(n,!1)}}function fi(e,t){let n=()=>{e(),r=Math.max(100,r-r/15),i=setTimeout(n,r)},r=350,i=setTimeout(n,500);e();let o=t.type=="touchstart"?"touchend":"mouseup";document.addEventListener(o,()=>clearTimeout(i),{once:!0})}var Es=e=>e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||document.activeElement instanceof HTMLInputElement||document.activeElement instanceof HTMLTextAreaElement,pi=e=>t=>{Es(t)||(t.key=="ArrowLeft"?e.goTo("prev"):t.key=="ArrowRight"?e.goTo("next"):t.key=="f"&&e.flip())};var mi=e=>E("div.lpv__menu.lpv__pane",[E("button.lpv__menu__entry.lpv__menu__flip.lpv__fbt",{hook:Rt("click",e.flip)},e.translate("flipTheBoard")),e.opts.menu.analysisBoard?.enabled?E("a.lpv__menu__entry.lpv__menu__analysis.lpv__fbt",{attrs:{href:e.analysisUrl(),target:"_blank"}},e.translate("analysisBoard")):void 0,e.opts.menu.practiceWithComputer?.enabled?E("a.lpv__menu__entry.lpv__menu__practice.lpv__fbt",{attrs:{href:e.practiceUrl(),target:"_blank"}},e.translate("practiceWithComputer")):void 0,e.opts.menu.getPgn.enabled?E("button.lpv__menu__entry.lpv__menu__pgn.lpv__fbt",{hook:Rt("click",e.togglePgn)},e.translate("getPgn")):void 0,As(e)]),As=e=>{let t=e.game.metadata.externalLink;return t&&E("a.lpv__menu__entry.lpv__fbt",{attrs:{href:t,target:"_blank"}},e.translate(e.game.metadata.isLichess?"viewOnLichess":"viewOnSite"))},gi=e=>E("div.lpv__controls",[e.pane=="board"?void 0:Ot(e,"first","step-backward"),Ot(e,"prev","left-open"),E("button.lpv__fbt.lpv__controls__menu.lpv__icon",{class:{active:e.pane!="board","lpv__icon-ellipsis-vert":e.pane=="board"},hook:Rt("click",e.toggleMenu)},e.pane=="board"?void 0:"X"),Ot(e,"next","right-open"),e.pane=="board"?void 0:Ot(e,"last","step-forward")]),Ot=(e,t,n)=>E(`button.lpv__controls__goto.lpv__controls__goto--${t}.lpv__fbt.lpv__icon.lpv__icon-${n}`,{class:{disabled:e.pane=="board"&&!e.canGoTo(t)},hook:Ie(r=>hi(r,i=>fi(()=>e.goTo(t),i)))});var ki=e=>{let t=_s[e];return t?E("nag",{attrs:{title:t.name}},t.symbol):void 0},_s={1:{symbol:"!",name:"Good move"},2:{symbol:"?",name:"Mistake"},3:{symbol:"!!",name:"Brilliant move"},4:{symbol:"??",name:"Blunder"},5:{symbol:"!?",name:"Interesting move"},6:{symbol:"?!",name:"Dubious move"},7:{symbol:"\u25A1",name:"Only move"},22:{symbol:"\u2A00",name:"Zugzwang"},10:{symbol:"=",name:"Equal position"},13:{symbol:"\u221E",name:"Unclear position"},14:{symbol:"\u2A72",name:"White is slightly better"},15:{symbol:"\u2A71",name:"Black is slightly better"},16:{symbol:"\xB1",name:"White is better"},17:{symbol:"\u2213",name:"Black is better"},18:{symbol:"+\u2212",name:"White is winning"},19:{symbol:"-+",name:"Black is winning"},146:{symbol:"N",name:"Novelty"},32:{symbol:"\u2191\u2191",name:"Development"},36:{symbol:"\u2191",name:"Initiative"},40:{symbol:"\u2192",name:"Attack"},132:{symbol:"\u21C6",name:"Counterplay"},138:{symbol:"\u2295",name:"Time trouble"},44:{symbol:"=\u221E",name:"With compensation"},140:{symbol:"\u2206",name:"With the idea"}};var wi=e=>E("div.lpv__side",[E("div.lpv__moves",{hook:{insert:t=>{let n=t.elm;e.path.empty()||bi(e,n),n.addEventListener("mousedown",r=>{let i=r.target.getAttribute("p");i&&e.toPath(new te(i))},{passive:!0})},postpatch:(t,n)=>{e.autoScrollRequested&&(bi(e,n.elm),e.autoScrollRequested=!1)}}},[...e.game.initial.comments.map(qt),...Ts(e),...Ns(e)])]),Ns=e=>{let t=e.game.metadata.result;return t&&t!="*"?[E("comment.result",e.game.metadata.result)]:[]},Rn=()=>E("move.empty","..."),On=e=>E("index",`${e}.`),qt=e=>E("comment",e),Rs=()=>E("paren.open","("),Os=()=>E("paren.close",")"),Tt=e=>Math.floor((e.ply-1)/2)+1,Ts=e=>{let t=Ds(e),n=[],r,i=e.game.moves.children.slice(1);for(e.game.initial.pos.turn=="black"&&e.game.mainline[0]&&n.push(On(e.game.initial.pos.fullmoves),Rn());r=(r||e.game.moves).children[0];){let o=r.data,s=o.ply%2==1;s&&n.push(On(Tt(o))),n.push(t(o));let a=s&&(i.length||o.comments.length)&&r.children.length;a&&n.push(Rn()),o.comments.forEach(u=>n.push(qt(u))),i.forEach(u=>n.push(qs(t,u))),a&&n.push(On(Tt(o)),Rn()),i=r.children.slice(1)}return n},qs=(e,t)=>E("variation",[...t.data.startingComments.map(qt),...vi(e,t)]),vi=(e,t)=>{let n=[],r=[];t.data.ply%2==0&&n.push(E("index",[Tt(t.data),"..."]));do{let i=t.data;i.ply%2==1&&n.push(E("index",[Tt(i),"."])),n.push(e(i)),i.comments.forEach(o=>n.push(qt(o))),r.forEach(o=>{n=[...n,Rs(),...vi(e,o),Os()]}),r=t.children.slice(1),t=t.children[0]}while(t);return n},Ds=e=>t=>E("move",{class:{current:e.path.equals(t.path),ancestor:e.path.contains(t.path),good:t.nags.includes(1),mistake:t.nags.includes(2),brilliant:t.nags.includes(3),blunder:t.nags.includes(4),interesting:t.nags.includes(5),inaccuracy:t.nags.includes(6)},attrs:{p:t.path.path}},[t.san,...t.nags.map(ki)]),bi=(e,t)=>{let n=t.querySelector(".current");if(!n){t.scrollTop=e.path.empty()?0:99999;return}t.scrollTop=n.offsetTop-t.offsetHeight/2+n.offsetHeight};function Dt(e,t){let n=t=="bottom"?e.orientation():M(e.orientation()),r=e.game.players[n],i=[r.title?E("span.lpv__player__title",r.title):void 0,E("span.lpv__player__name",r.name),r.rating?E("span.lpv__player__rating",["(",r.rating,")"]):void 0];return E(`div.lpv__player.lpv__player--${t}`,[r.isLichessUser?E("a.lpv__player__person.ulpt.user-link",{attrs:{href:`${e.opts.lichess}/@/${r.name}`}},i):E("span.lpv__player__person",i),e.opts.showClocks?Bs(e,n):void 0])}var Bs=(e,t)=>{let n=e.curData(),r=n.clocks&&n.clocks[t];return typeof r==null?void 0:E("div.lpv__player__clock",{class:{active:t==n.turn}},Ls(r))},Ls=e=>{if(!e&&e!==0)return["-"];let t=new Date(e*1e3),n=":",r=yi(t.getUTCMinutes())+n+yi(t.getUTCSeconds());return e>=3600?[Math.floor(e/3600)+n+r]:[r]},yi=e=>(e<10?"0":"")+e;function Bt(e){let t=e.opts,n=`lpv.lpv--moves-${t.showMoves}.lpv--controls-${t.showControls}${t.classes?"."+t.classes.replace(" ","."):""}`,r=t.showPlayers=="auto"?e.game.hasPlayerName():t.showPlayers;return E(`div.${n}`,{class:{"lpv--menu":e.pane!="board","lpv--players":r},attrs:{tabindex:0},hook:Ie(i=>{e.setGround(ii(i.querySelector(".cg-wrap"),zs(e,i))),t.keyboardToMove&&i.addEventListener("keydown",pi(e))})},[r?Dt(e,"top"):void 0,Is(e),r?Dt(e,"bottom"):void 0,t.showControls?gi(e):void 0,t.showMoves?wi(e):void 0,e.pane=="menu"?mi(e):e.pane=="pgn"?Ks(e):void 0])}var Is=e=>E("div.lpv__board",{hook:Ie(t=>{t.addEventListener("click",e.focus),e.opts.scrollToMove&&!("ontouchstart"in window)&&t.addEventListener("wheel",di((n,r)=>{n.preventDefault(),n.deltaY>0&&r?e.goTo("next",!1):n.deltaY<0&&r&&e.goTo("prev",!1)}))})},E("div.cg-wrap")),Ks=e=>{let t=new Blob([e.opts.pgn],{type:"text/plain"});return E("div.lpv__pgn.lpv__pane",[E("a.lpv__pgn__download.lpv__fbt",{attrs:{href:window.URL.createObjectURL(t),download:e.opts.menu.getPgn.fileName||`${e.game.title()}.pgn`}},e.translate("download")),E("textarea.lpv__pgn__text",e.opts.pgn)])},zs=(e,t)=>({viewOnly:!e.opts.drawArrows,addDimensionsCssVarsTo:t,drawable:{enabled:e.opts.drawArrows,visible:!0},disableContextMenu:e.opts.drawArrows,...e.opts.chessground||{},movable:{free:!1},draggable:{enabled:!1},selectable:{enabled:!1},...e.cgState()});var Fs={pgn:"*",fen:void 0,showPlayers:"auto",showClocks:!0,showMoves:"auto",showControls:!0,scrollToMove:!0,keyboardToMove:!0,orientation:void 0,initialPly:0,chessground:{},drawArrows:!0,menu:{getPgn:{enabled:!0,fileName:void 0},practiceWithComputer:{enabled:!0},analysisBoard:{enabled:!0}},lichess:"https://lichess.org",classes:void 0};function Si(e,t){let n={...Fs};return Ci(n,t),n.fen&&(n.pgn=`[FEN "${n.fen}"]
${n.pgn}`),n.classes||(n.classes=e.className),n}function Ci(e,t){for(let n in t)typeof t[n]<"u"&&(xi(e[n])&&xi(t[n])?Ci(e[n],t[n]):e[n]=t[n])}function xi(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}function Hs(e,t){let n=An([Nn,_n]),r=Si(e,t),i=new We(r,a),o=Bt(i);e.innerHTML="";let s=n(e,o);i.div=s.elm;function a(){s=n(s,Bt(i))}return i}export{Hs as default};
